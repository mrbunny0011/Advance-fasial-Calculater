<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Faisal's Complete Trading Dashboard</title>
  <style>
    body {
      background: #f0f8ff;
      color: #2d3748;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    h1 {
      text-align: center;
      color: #2c6df8;
      margin: 10px 0;
      padding: 0;
      font-size: 24px;
      background: #e1f0ff;
      padding: 10px;
      border-radius: 8px;
      width: calc(100% - 40px);
      margin: 10px auto;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .dashboard-controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 10px auto;
      flex-wrap: wrap;
      padding: 0 20px;
    }
    .dashboard-controls button {
      padding: 8px 16px;
      min-width: 120px;
    }
    .models-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 0 10px;
      margin-bottom: 20px;
    }
    .model-container {
      border: 2px solid #c3dafe;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      flex-grow: 1;
      min-width: calc(100% - 20px);
      transition: all 0.3s ease;
      resize: both;
      min-height: 300px;
    }
    .model-container.pinned {
      order: -1;
      border: 2px solid #ff9800;
    }
    .model-container.favorite {
      border: 2px solid #ffeb3b;
      background: #fffde7;
    }
    .model-container.fullscreen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1000;
      margin: 0;
      border-radius: 0;
      min-width: 100%;
      resize: none;
    }
    .model-header {
      background: #d4e3ff;
      padding: 10px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #c3dafe;
      cursor: move;
    }
    .model-container.pinned .model-header {
      background: #ffe0b2;
    }
    .model-container.favorite .model-header {
      background: #fff9c4;
    }
    .model-title {
      font-size: 18px;
      color: #2c6df8;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .model-container.pinned .model-title {
      color: #ff9800;
    }
    .model-container.favorite .model-title {
      color: #ffc107;
    }
    .model-controls {
      display: flex;
      gap: 8px;
    }
    button {
      padding: 6px 12px;
      background: #4a8cff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      touch-action: manipulation;
      transition: all 0.2s ease;
    }
    button:hover {
      background: #3a7cff;
      transform: translateY(-1px);
    }
    button.secondary {
      background: #e1f0ff;
      color: #2c6df8;
      border: 1px solid #c3dafe;
    }
    button.active {
      background: #00c3a5;
      color: white;
    }
    button.warning {
      background: #ff9800;
      color: white;
    }
    button.star {
      background: #ffc107;
      color: white;
    }
    button.screenshot-btn {
      background: #9c27b0 !important;
    }
    iframe {
      width: 100%;
      height: calc(100% - 50px);
      border: none;
      background: white;
    }
    .hidden {
      display: none;
    }

    /* View modes */
    .single-view .model-container {
      min-width: calc(100% - 20px);
      height: auto;
    }
    .two-column-view .model-container {
      min-width: calc(50% - 15px);
      flex-basis: calc(50% - 15px);
      height: auto;
    }
    .quadrant-view .model-container {
      min-width: calc(50% - 15px);
      flex-basis: calc(50% - 15px);
      height: calc(50vh - 15px);
    }
    .quadrant-view iframe {
      height: calc(100% - 50px);
    }

    /* Add model controls */
    .add-model-container {
      background: #e1f0ff;
      padding: 15px;
      border-radius: 8px;
      margin: 10px auto;
      width: calc(100% - 40px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .add-model-form {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    .add-model-form input, .add-model-form select {
      padding: 8px 12px;
      border: 1px solid #c3dafe;
      border-radius: 6px;
      flex-grow: 1;
      min-width: 200px;
    }
    .add-model-form button {
      min-width: 100px;
    }

    /* Search bar */
    .search-container {
      margin: 10px auto;
      width: calc(100% - 40px);
      max-width: 600px;
    }
    #globalSearch {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid #c3dafe;
      border-radius: 6px;
      font-size: 16px;
    }

    /* Modal for editing */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
    }
    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 15px;
    }

    /* Folder/Section styling */
    .folder-container {
      width: 100%;
      margin-bottom: 15px;
    }
    .folder-header {
      background: #4a8cff;
      color: white;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }
    .folder-header:hover {
      background: #3a7cff;
    }
    .folder-content {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 0 10px;
    }
    .folder-title {
      font-weight: bold;
      font-size: 18px;
    }
    .folder-controls {
      display: flex;
      gap: 5px;
    }
    .folder-controls button {
      padding: 2px 8px;
      font-size: 12px;
    }

    /* Favorites section */
    #favorites-section {
      background: #fffde7;
      border: 2px solid #ffeb3b;
      border-radius: 8px;
      margin-bottom: 15px;
      padding: 5px;
    }
    #favorites-section .folder-header {
      background: #ffc107;
    }
    #favorites-section .folder-header:hover {
      background: #ffb300;
    }

    /* Layout locked state */
    body.layout-locked .model-container {
      resize: none;
    }
    body.layout-locked .model-header {
      cursor: default;
    }

    /* Screenshot notification */
    .screenshot-notification {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #4CAF50;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 1001;
      display: none;
    }

    /* Mobile-specific styles */
    @media (max-width: 768px) {
      h1 {
        font-size: 20px;
        padding: 0 10px;
      }
      
      .dashboard-controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .dashboard-controls button {
        width: 100%;
      }
      
      .model-header {
        flex-direction: column;
        align-items: flex-start;
        padding: 8px 10px;
      }
      
      .model-title {
        font-size: 16px;
        margin-bottom: 8px;
      }
      
      .model-controls {
        width: 100%;
        justify-content: space-between;
        flex-wrap: wrap;
      }
      
      .model-controls button {
        flex-grow: 1;
        margin: 2px;
      }
      
      button {
        padding: 8px 12px;
        font-size: 14px;
        min-width: 60px;
      }
      
      iframe {
        height: calc(100vh - 100px);
      }
      
      /* Force single column on mobile */
      .two-column-view .model-container,
      .quadrant-view .model-container {
        min-width: calc(100% - 20px);
        flex-basis: auto;
        height: auto;
        resize: none;
      }
      .quadrant-view iframe {
        height: calc(100vh - 100px);
      }
    }

    @media (max-width: 480px) {
      .model-controls {
        flex-wrap: wrap;
      }
      
      button {
        flex-grow: 1;
      }
      
      .add-model-form {
        flex-direction: column;
      }
      
      .add-model-form input, .add-model-form select {
        width: 100%;
      }
    }
  </style>
  <!-- Include html2canvas library for screenshots -->
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>
<body>
  <h1>üìä Faisal's Complete Trading Dashboard</h1>

  <div class="dashboard-controls">
    <button class="active" onclick="setViewMode('single')">Single View</button>
    <button onclick="setViewMode('two-column')">2-Column Split</button>
    <button onclick="setViewMode('quadrant')">4-Quadrant View</button>
    <button class="secondary" onclick="showAddModelForm()">+ Add New Model</button>
    <button id="lockLayoutBtn" class="secondary" onclick="toggleLayoutLock()">Lock Layout</button>
  </div>

  <div class="search-container">
    <input type="text" id="globalSearch" placeholder="üîç Search models by title, icon or URL..." oninput="filterModels()">
  </div>

  <div class="add-model-container hidden" id="addModelContainer">
    <div class="add-model-form">
      <input type="text" id="newModelTitle" placeholder="Model Title (e.g., TradingView Chart)" required>
      <input type="text" id="newModelIcon" placeholder="Icon (e.g., üìä, üîç, üí∞)">
      <input type="url" id="newModelUrl" placeholder="URL (e.g., https://example.com)" required>
      <select id="newModelFolder">
        <option value="">No Folder</option>
        <option value="favorites">Favorites</option>
        <option value="technical">Technical Analysis</option>
        <option value="fundamental">Fundamental Analysis</option>
        <option value="custom">Custom Folder</option>
      </select>
      <input type="text" id="newCustomFolder" placeholder="Custom Folder Name" class="hidden">
      <button onclick="addNewModel()">Add Model</button>
      <button class="secondary" onclick="hideAddModelForm()">Cancel</button>
    </div>
  </div>

  <div id="models-container">
    <!-- Favorites section -->
    <div class="folder-container" id="favorites-section">
      <div class="folder-header" onclick="toggleFolder('favorites')">
        <span class="folder-title">‚≠ê Favorites</span>
        <span class="folder-controls">
          <button class="secondary" onclick="event.stopPropagation();editFolder('favorites')">Edit</button>
          <button class="secondary" onclick="event.stopPropagation();collapseAllFolders()">Collapse All</button>
        </span>
      </div>
      <div class="folder-content" id="favorites-folder"></div>
    </div>

    <!-- Other folders will be added here dynamically -->
  </div>

  <!-- Edit Modal -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <h3>Edit Model</h3>
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px;">Title:</label>
        <input type="text" id="editModelTitle" style="width: 100%; padding: 8px;">
      </div>
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px;">Icon:</label>
        <input type="text" id="editModelIcon" style="width: 100%; padding: 8px;">
      </div>
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px;">URL:</label>
        <input type="url" id="editModelUrl" style="width: 100%; padding: 8px;">
      </div>
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px;">Folder:</label>
        <select id="editModelFolder" style="width: 100%; padding: 8px;">
          <option value="">No Folder</option>
          <option value="favorites">Favorites</option>
          <option value="technical">Technical Analysis</option>
          <option value="fundamental">Fundamental Analysis</option>
          <option value="custom">Custom Folder</option>
        </select>
        <input type="text" id="editCustomFolder" placeholder="Custom Folder Name" class="hidden" style="width: 100%; padding: 8px; margin-top: 5px;">
      </div>
      <div class="modal-buttons">
        <button class="secondary" onclick="hideEditModal()">Cancel</button>
        <button onclick="saveModelChanges()">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Folder Edit Modal -->
  <div class="modal" id="folderEditModal">
    <div class="modal-content">
      <h3>Edit Folder</h3>
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px;">Folder Name:</label>
        <input type="text" id="editFolderName" style="width: 100%; padding: 8px;">
      </div>
      <div class="modal-buttons">
        <button class="secondary" onclick="hideFolderEditModal()">Cancel</button>
        <button onclick="confirmFolderEdit()">Save Changes</button>
        <button class="warning" onclick="deleteFolder()">Delete Folder</button>
      </div>
    </div>
  </div>

  <!-- Screenshot notification -->
  <div class="screenshot-notification" id="screenshotNotification">
    Screenshot saved successfully!
  </div>

  <script>
    // Global variables
    let currentViewMode = 'single';
    let fullScreenModel = null;
    let currentEditModel = null;
    let currentEditFolder = null;
    let layoutLocked = false;
    let models = [
      {
        id: 'model1',
        title: 'Model 1 ‚Äì Legend: The Liquidity Zone',
        icon: 'üìå',
        url: 'https://mrbunny0011.github.io/Advance-fasial-Calculater/LegendTheliquidityZone.html',
        folder: '',
        favorite: false
      },
      {
        id: 'model2',
        title: 'Model 2 ‚Äì Multan Calculation',
        icon: 'üìå',
        url: 'https://mrbunny0011.github.io/Advance-fasial-Calculater/MultanCalculation.html',
        folder: '',
        favorite: false
      },
      {
        id: 'model3',
        title: 'Model 3 ‚Äì Gold Calculation',
        icon: 'üìå',
        url: 'https://mrbunny0011.github.io/Advance-fasial-Calculater/GoldClculation.html',
        folder: '',
        favorite: false
      },
      {
        id: 'model4',
        title: 'Model 4 ‚Äì Volume Profile',
        icon: 'üìå',
        url: 'https://mrbunny0011.github.io/Advance-fasial-Calculater/volumProfile.html',
        folder: '',
        favorite: false
      },
      {
        id: 'model5',
        title: 'Model 5 ‚Äì Advance Dimand',
        icon: 'üìå',
        url: 'https://mrbunny0011.github.io/Advance-fasial-Calculater/Advance_diamond.html',
        folder: '',
        favorite: false
      },
      {
        id: 'model6',
        title: 'Model 6 ‚Äì Order Book',
        icon: 'üìå',
        url: 'https://mrbunny0011.github.io/Advance-fasial-Calculater/OrderBook.html',
        folder: '',
        favorite: false
      },
      {
        id: 'model7',
        title: 'Model 7 ‚Äì Liquidity',
        icon: 'üìå',
        url: 'https://www.coinglass.com/pro/futures/LiquidationHeatMap',
        folder: '',
        favorite: false
      },
      {
        id: 'model8',
        title: 'Model 8 ‚Äì Dimand',
        icon: 'üìå',
        url: 'https://mrbunny0011.github.io/Advance-fasial-Calculater/dimand.html',
        folder: '',
        favorite: false
      }
    ];

    let folders = {
      'favorites': { name: 'Favorites', collapsed: false },
      'technical': { name: 'Technical Analysis', collapsed: false },
      'fundamental': { name: 'Fundamental Analysis', collapsed: false }
    };

    // Initialize the dashboard
    function initializeDashboard() {
      const container = document.getElementById('models-container');
      
      // Load models and folders from localStorage if available
      const savedModels = localStorage.getItem('dashboardModels');
      const savedFolders = localStorage.getItem('dashboardFolders');
      
      if (savedModels) models = JSON.parse(savedModels);
      if (savedFolders) folders = JSON.parse(savedFolders);
      
      // Create folder structure
      createFolderStructure();
      
      // Create model elements
      models.forEach(model => {
        addModelToFolder(model);
      });
      
      // Load view mode
      const savedViewMode = localStorage.getItem('dashboardViewMode') || 'single';
      setViewMode(savedViewMode);
      
      // Load full screen state
      const savedFullScreenModel = localStorage.getItem('fullScreenModel');
      if (savedFullScreenModel) {
        toggleFullScreen(savedFullScreenModel);
      }
      
      // Load layout lock state
      const savedLayoutLocked = localStorage.getItem('layoutLocked') === 'true';
      if (savedLayoutLocked) {
        toggleLayoutLock(true);
      }
      
      // Make models draggable
      makeModelsDraggable();
      
      // Setup folder toggle for custom folders
      setupFolderToggles();
      
      // Setup folder select change handler
      document.getElementById('newModelFolder').addEventListener('change', function() {
        const customFolderInput = document.getElementById('newCustomFolder');
        customFolderInput.classList.toggle('hidden', this.value !== 'custom');
      });
      
      document.getElementById('editModelFolder').addEventListener('change', function() {
        const customFolderInput = document.getElementById('editCustomFolder');
        customFolderInput.classList.toggle('hidden', this.value !== 'custom');
      });
    }

    // Create folder structure
    function createFolderStructure() {
      const container = document.getElementById('models-container');
      
      // Clear existing folders (except favorites)
      document.querySelectorAll('.folder-container:not(#favorites-section)').forEach(el => el.remove());
      
      // Create other folders
      for (const [folderId, folder] of Object.entries(folders)) {
        if (folderId === 'favorites') continue;
        
        const folderHtml = `
          <div class="folder-container" id="${folderId}-section">
            <div class="folder-header" onclick="toggleFolder('${folderId}')">
              <span class="folder-title">${folder.name}</span>
              <span class="folder-controls">
                <button class="secondary" onclick="event.stopPropagation();editFolder('${folderId}')">Edit</button>
                <button class="secondary" onclick="event.stopPropagation();collapseAllFolders()">Collapse All</button>
              </span>
            </div>
            <div class="folder-content ${folder.collapsed ? 'hidden' : ''}" id="${folderId}-folder"></div>
          </div>
        `;
        
        // Insert after favorites section
        document.getElementById('favorites-section').insertAdjacentHTML('afterend', folderHtml);
      }
    }

    // Add model to appropriate folder
    function addModelToFolder(model) {
      let folderId = model.folder || '';
      
      // If marked as favorite but not in favorites folder, add to favorites
      if (model.favorite && (!model.folder || model.folder !== 'favorites')) {
        folderId = 'favorites';
        model.folder = 'favorites';
      }
      
      const folderElement = folderId ? document.getElementById(`${folderId}-folder`) : 
        document.getElementById('models-container');
      
      if (!folderElement) {
        console.error(`Folder not found: ${folderId}`);
        return;
      }
      
      const modelEl = createModelElement(model);
      folderElement.appendChild(modelEl);
    }

    // Create a model element
    function createModelElement(model) {
      const modelEl = document.createElement('div');
      modelEl.className = 'model-container';
      modelEl.id = model.id;
      if (model.favorite) modelEl.classList.add('favorite');
      
      modelEl.innerHTML = `
        <div class="model-header">
          <div class="model-title">${model.icon || 'üìå'} ${model.title}</div>
          <div class="model-controls">
            <button onclick="toggleFullScreen('${model.id}')">Full Screen</button>
            <button class="secondary" onclick="showEditModal('${model.id}')">Edit</button>
            <button class="${model.favorite ? 'star' : 'secondary'}" onclick="toggleFavorite('${model.id}')">
              ${model.favorite ? '‚≠ê' : '‚òÜ'}
            </button>
            <button class="screenshot-btn" onclick="takeScreenshot('${model.id}')">üì∑ Screenshot</button>
            <button class="secondary" onclick="resetModel('${model.id}')">Reset</button>
            <button class="secondary" onclick="removeModel('${model.id}')">Remove</button>
          </div>
        </div>
        <iframe id="${model.id}-iframe" src="${model.url}"></iframe>
      `;
      
      return modelEl;
    }

     async function takeScreenshot(modelId) {
    const modelElement = document.getElementById(modelId);
    if (!modelElement) return;

    // Hide buttons for a clean capture
    const buttons = modelElement.querySelectorAll('button');
    buttons.forEach(btn => (btn.style.visibility = 'hidden'));

    // Give the browser one paint frame so layout settles
    await new Promise(r => requestAnimationFrame(r));

    // Decide what to capture
    let targetEl = modelElement; // default: whole card
    const iframe = modelElement.querySelector('iframe');
    if (iframe) {
      try {
        // If iframe is same‚Äëorigin we can capture its real content
        const iDoc = iframe.contentWindow.document;
        if (iDoc && iDoc.domain === document.domain) {
          targetEl = iDoc.body; // capture only the inner page for perfect quality
        }
      } catch (_) {
        /* Cross‚Äëorigin ‚Äì fall back to outer card */
      }
    }

    // Do the capture
    html2canvas(targetEl, {
      backgroundColor: null,  // preserve transparency / page bg
      useCORS: true,          // try CORS for any remote images
      allowTaint: false,      // if a remote image blocks CORS, skip it but don‚Äôt blank
      scale: 2,               // retina‚Äësharp
      scrollY: -window.scrollY
    }).then(canvas => {
      // Restore UI
      buttons.forEach(btn => (btn.style.visibility = 'visible'));

      // Download
      const ts = new Date().toISOString().replace(/[:.]/g, '-');
      const link = document.createElement('a');
      link.download = `dashboard-${modelId}-${ts}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();

      // Toast
      const note = document.getElementById('screenshotNotification');
      if (note) {
        note.style.display = 'block';
        setTimeout(() => (note.style.display = 'none'), 4000);
      }
    }).catch(err => {
      buttons.forEach(btn => (btn.style.visibility = 'visible'));
      alert('‚ö†Ô∏è Screenshot failed. Possibly due to cross‚Äëorigin iframe.  ' + err.message);
    });
  }

    // Set view mode (single, two-column, quadrant)
    function setViewMode(mode) {
      currentViewMode = mode;
      const container = document.getElementById('models-container');
      const buttons = document.querySelectorAll('.dashboard-controls button');
      
      // Update active button
      buttons.forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.includes(mode.replace('-', ' '))) {
          btn.classList.add('active');
        }
      });
      
      // Update container class
      container.className = 'models-container';
      if (mode === 'two-column') {
        container.classList.add('two-column-view');
      } else if (mode === 'quadrant') {
        container.classList.add('quadrant-view');
      } else {
        container.classList.add('single-view');
      }
      
      // Exit full screen if in that mode
      if (fullScreenModel) {
        toggleFullScreen(fullScreenModel);
      }
      
      // Save view mode to local storage
      localStorage.setItem('dashboardViewMode', mode);
    }

    // Toggle full screen mode
    function toggleFullScreen(model) {
      const modelEl = document.getElementById(model);
      const modelsContainer = document.getElementById('models-container');
      
      if (!modelEl.classList.contains('fullscreen')) {
        // Enter full screen
        modelEl.dataset.previousClasses = modelsContainer.className;
        modelsContainer.className = 'models-container';
        
        document.querySelectorAll('.model-container').forEach(m => {
          if (m.id !== model) m.classList.add('hidden');
        });
        
        modelEl.classList.add('fullscreen');
        const iframe = modelEl.querySelector('iframe');
        if (iframe) {
          iframe.style.height = 'calc(100vh - 60px)';
        }
        
        const btn = modelEl.querySelector('.model-controls button:first-child');
        btn.textContent = 'Minimize';
        fullScreenModel = model;
      } else {
        // Exit full screen
        modelEl.classList.remove('fullscreen');
        
        if (modelEl.dataset.previousClasses) {
          modelsContainer.className = modelEl.dataset.previousClasses;
        }
        
        document.querySelectorAll('.model-container').forEach(m => {
          m.classList.remove('hidden');
        });
        
        const iframe = modelEl.querySelector('iframe');
        if (iframe) {
          iframe.style.height = '';
        }
        
        const btn = modelEl.querySelector('.model-controls button:first-child');
        btn.textContent = 'Full Screen';
        fullScreenModel = null;
      }
      
      saveFullScreenState();
    }

    // Reset model to original state
    function resetModel(model) {
      const iframe = document.getElementById(`${model}-iframe`);
      const modelData = models.find(m => m.id === model);
      if (iframe && modelData) {
        iframe.src = modelData.url;
      }
    }

    // Show add model form
    function showAddModelForm() {
      document.getElementById('addModelContainer').classList.remove('hidden');
      document.getElementById('newModelTitle').focus();
    }

    // Hide add model form
    function hideAddModelForm() {
      document.getElementById('addModelContainer').classList.add('hidden');
      document.getElementById('newModelTitle').value = '';
      document.getElementById('newModelIcon').value = '';
      document.getElementById('newModelUrl').value = '';
      document.getElementById('newModelFolder').value = '';
      document.getElementById('newCustomFolder').value = '';
      document.getElementById('newCustomFolder').classList.add('hidden');
    }

    // Add new model
    function addNewModel() {
      const title = document.getElementById('newModelTitle').value.trim();
      const icon = document.getElementById('newModelIcon').value.trim() || 'üìå';
      const url = document.getElementById('newModelUrl').value.trim();
      const folder = document.getElementById('newModelFolder').value;
      const customFolder = document.getElementById('newCustomFolder').value.trim();
      
      if (!title || !url) {
        alert('Please enter both title and URL');
        return;
      }
      
      if (folder === 'custom' && !customFolder) {
        alert('Please enter a custom folder name');
        return;
      }
      
      // Create new model ID
      const newId = 'model-' + Date.now();
      
      // Determine folder
      let finalFolder = folder;
      if (folder === 'custom') {
        const folderId = customFolder.toLowerCase().replace(/\s+/g, '-');
        if (!folders[folderId]) {
          folders[folderId] = { name: customFolder, collapsed: false };
          saveFoldersToLocalStorage();
          createFolderStructure();
        }
        finalFolder = folderId;
      }
      
      const newModel = {
        id: newId,
        title: title,
        icon: icon,
        url: url,
        folder: finalFolder,
        favorite: finalFolder === 'favorites'
      };
      
      models.push(newModel);
      saveModelsToLocalStorage();
      addModelToFolder(newModel);
      hideAddModelForm();
    }

    // Show edit modal
    function showEditModal(modelId) {
      const model = models.find(m => m.id === modelId);
      if (!model) return;
      
      currentEditModel = modelId;
      document.getElementById('editModelTitle').value = model.title;
      document.getElementById('editModelIcon').value = model.icon;
      document.getElementById('editModelUrl').value = model.url;
      
      // Set folder selection
      const folderSelect = document.getElementById('editModelFolder');
      const customFolderInput = document.getElementById('editCustomFolder');
      
      if (model.folder === 'favorites' || model.folder === 'technical' || model.folder === 'fundamental') {
        folderSelect.value = model.folder;
        customFolderInput.classList.add('hidden');
      } else if (model.folder && folders[model.folder]) {
        folderSelect.value = 'custom';
        customFolderInput.value = folders[model.folder].name;
        customFolderInput.classList.remove('hidden');
      } else {
        folderSelect.value = '';
        customFolderInput.classList.add('hidden');
      }
      
      document.getElementById('editModal').style.display = 'flex';
    }

    // Hide edit modal
    function hideEditModal() {
      document.getElementById('editModal').style.display = 'none';
      currentEditModel = null;
    }

    // Save model changes
    function saveModelChanges() {
      if (!currentEditModel) return;
      
      const modelIndex = models.findIndex(m => m.id === currentEditModel);
      if (modelIndex === -1) return;
      
      const newTitle = document.getElementById('editModelTitle').value.trim();
      const newIcon = document.getElementById('editModelIcon').value.trim() || 'üìå';
      const newUrl = document.getElementById('editModelUrl').value.trim();
      const folder = document.getElementById('editModelFolder').value;
      const customFolder = document.getElementById('editCustomFolder').value.trim();
      
      if (!newTitle || !newUrl) {
        alert('Please enter both title and URL');
        return;
      }
      
      if (folder === 'custom' && !customFolder) {
        alert('Please enter a custom folder name');
        return;
      }
      
      // Determine folder
      let finalFolder = folder;
      if (folder === 'custom') {
        const folderId = customFolder.toLowerCase().replace(/\s+/g, '-');
        if (!folders[folderId]) {
          folders[folderId] = { name: customFolder, collapsed: false };
          saveFoldersToLocalStorage();
          createFolderStructure();
        }
        finalFolder = folderId;
      }
      
      // Check if folder changed
      const folderChanged = models[modelIndex].folder !== finalFolder;
      models[modelIndex].title = newTitle;
      models[modelIndex].icon = newIcon;
      models[modelIndex].url = newUrl;
      models[modelIndex].folder = finalFolder;
      
      // If moved to favorites, mark as favorite
      if (finalFolder === 'favorites') {
        models[modelIndex].favorite = true;
      }
      
      saveModelsToLocalStorage();
      
      // If folder changed, recreate the model element in new folder
      if (folderChanged) {
        const modelEl = document.getElementById(currentEditModel);
        if (modelEl) modelEl.remove();
        
        addModelToFolder(models[modelIndex]);
      } else {
        // Just update the existing model element
        const modelEl = document.getElementById(currentEditModel);
        if (modelEl) {
          const titleEl = modelEl.querySelector('.model-title');
          if (titleEl) {
            titleEl.textContent = `${models[modelIndex].icon} ${models[modelIndex].title}`;
          }
          
          const iframe = modelEl.querySelector('iframe');
          if (iframe) {
            iframe.src = models[modelIndex].url;
          }
          
          // Update favorite status
          modelEl.classList.toggle('favorite', models[modelIndex].favorite);
          const favoriteBtn = modelEl.querySelector('.model-controls button:nth-child(3)');
          if (favoriteBtn) {
            favoriteBtn.className = models[modelIndex].favorite ? 'star' : 'secondary';
            favoriteBtn.textContent = models[modelIndex].favorite ? '‚≠ê' : '‚òÜ';
          }
        }
      }
      
      hideEditModal();
    }

    // Toggle favorite status
    function toggleFavorite(modelId) {
      const modelIndex = models.findIndex(m => m.id === modelId);
      if (modelIndex === -1) return;
      
      models[modelIndex].favorite = !models[modelIndex].favorite;
      
      // If marking as favorite and not in favorites folder, move to favorites
      if (models[modelIndex].favorite && models[modelIndex].folder !== 'favorites') {
        models[modelIndex].folder = 'favorites';
      }
      
      saveModelsToLocalStorage();
      
      // Update the model element
      const modelEl = document.getElementById(modelId);
      if (modelEl) {
        modelEl.classList.toggle('favorite', models[modelIndex].favorite);
        
        const favoriteBtn = modelEl.querySelector('.model-controls button:nth-child(3)');
        if (favoriteBtn) {
          favoriteBtn.className = models[modelIndex].favorite ? 'star' : 'secondary';
          favoriteBtn.textContent = models[modelIndex].favorite ? '‚≠ê' : '‚òÜ';
        }
        
        // If favorite status changed, recreate in correct folder
        const currentFolder = modelEl.parentElement.id.replace('-folder', '');
        if ((models[modelIndex].favorite && currentFolder !== 'favorites') || 
            (!models[modelIndex].favorite && currentFolder === 'favorites' && models[modelIndex].folder !== 'favorites')) {
          modelEl.remove();
          addModelToFolder(models[modelIndex]);
        }
      }
    }

    // Remove model
    function removeModel(modelId) {
      if (!confirm('Are you sure you want to remove this model?')) return;
      
      const modelIndex = models.findIndex(m => m.id === modelId);
      if (modelIndex === -1) return;
      
      models.splice(modelIndex, 1);
      saveModelsToLocalStorage();
      
      const modelEl = document.getElementById(modelId);
      if (modelEl) {
        modelEl.remove();
      }
    }

    // Toggle folder collapse/expand
    function toggleFolder(folderId) {
      if (layoutLocked) return;
      
      const folderContent = document.getElementById(`${folderId}-folder`);
      if (!folderContent) return;
      
      folderContent.classList.toggle('hidden');
      folders[folderId].collapsed = folderContent.classList.contains('hidden');
      saveFoldersToLocalStorage();
    }

    // Collapse all folders
    function collapseAllFolders() {
      for (const folderId in folders) {
        const folderContent = document.getElementById(`${folderId}-folder`);
        if (folderContent) {
          folderContent.classList.add('hidden');
          folders[folderId].collapsed = true;
        }
      }
      saveFoldersToLocalStorage();
    }

    // Expand all folders
    function expandAllFolders() {
      for (const folderId in folders) {
        const folderContent = document.getElementById(`${folderId}-folder`);
        if (folderContent) {
          folderContent.classList.remove('hidden');
          folders[folderId].collapsed = false;
        }
      }
      saveFoldersToLocalStorage();
    }

    // Edit folder
    function editFolder(folderId) {
      currentEditFolder = folderId;
      document.getElementById('editFolderName').value = folders[folderId].name;
      document.getElementById('folderEditModal').style.display = 'flex';
    }

    // Hide folder edit modal
    function hideFolderEditModal() {
      document.getElementById('folderEditModal').style.display = 'none';
      currentEditFolder = null;
    }

    // Confirm folder edit
    function confirmFolderEdit() {
      if (!currentEditFolder) return;
      
      const newName = document.getElementById('editFolderName').value.trim();
      if (!newName) {
        alert('Please enter a folder name');
        return;
      }
      
      folders[currentEditFolder].name = newName;
      saveFoldersToLocalStorage();
      
      // Update folder title
      const folderTitle = document.querySelector(`#${currentEditFolder}-section .folder-title`);
      if (folderTitle) {
        folderTitle.textContent = newName;
      }
      
      hideFolderEditModal();
    }

    // Delete folder
    function deleteFolder() {
      if (!currentEditFolder || currentEditFolder === 'favorites') return;
      
      if (!confirm(`Are you sure you want to delete the "${folders[currentEditFolder].name}" folder? Models will be moved to the main area.`)) {
        return;
      }
      
      // Move all models in this folder to no folder
      models.forEach(model => {
        if (model.folder === currentEditFolder) {
          model.folder = '';
        }
      });
      
      // Remove folder
      delete folders[currentEditFolder];
      saveFoldersToLocalStorage();
      saveModelsToLocalStorage();
      
      // Rebuild the dashboard
      initializeDashboard();
      
      hideFolderEditModal();
    }

    // Toggle layout lock
    function toggleLayoutLock(initialLoad = false) {
      layoutLocked = !layoutLocked;
      document.body.classList.toggle('layout-locked', layoutLocked);
      
      const lockBtn = document.getElementById('lockLayoutBtn');
      if (lockBtn) {
        lockBtn.textContent = layoutLocked ? 'Unlock Layout' : 'Lock Layout';
        lockBtn.className = layoutLocked ? 'active' : 'secondary';
      }
      
      if (!initialLoad) {
        localStorage.setItem('layoutLocked', layoutLocked);
      }
    }

    // Filter models based on search query
    function filterModels() {
      const query = document.getElementById('globalSearch').value.toLowerCase();
      
      if (!query) {
        // Show all models if search is empty
        document.querySelectorAll('.model-container').forEach(model => {
          model.style.display = '';
        });
        return;
      }
      
      document.querySelectorAll('.model-container').forEach(model => {
        const modelData = models.find(m => m.id === model.id);
        if (!modelData) return;
        
        const matches = modelData.title.toLowerCase().includes(query) || 
                       modelData.icon.toLowerCase().includes(query) || 
                       modelData.url.toLowerCase().includes(query);
        
        model.style.display = matches ? '' : 'none';
      });
    }

    // Make models draggable
    function makeModelsDraggable() {
      const containers = document.querySelectorAll('.model-container');
      
      containers.forEach(container => {
        const header = container.querySelector('.model-header');
        if (!header) return;
        
        header.addEventListener('mousedown', function(e) {
          if (e.target.tagName === 'BUTTON' || layoutLocked) return;
          
          const startX = e.clientX;
          const startY = e.clientY;
          const startLeft = container.offsetLeft;
          const startTop = container.offsetTop;
          
          function moveElement(e) {
            container.style.position = 'absolute';
            container.style.left = (startLeft + e.clientX - startX) + 'px';
            container.style.top = (startTop + e.clientY - startY) + 'px';
            container.style.zIndex = '100';
          }
          
          function stopDrag() {
            document.removeEventListener('mousemove', moveElement);
            document.removeEventListener('mouseup', stopDrag);
            
            // Snap back to grid after a short delay
            setTimeout(() => {
              container.style.position = '';
              container.style.left = '';
              container.style.top = '';
              container.style.zIndex = '';
            }, 100);
          }
          
          document.addEventListener('mousemove', moveElement);
          document.addEventListener('mouseup', stopDrag);
        });
      });
    }

    // Setup folder toggles
    function setupFolderToggles() {
      for (const folderId in folders) {
        const folderHeader = document.querySelector(`#${folderId}-section .folder-header`);
        if (folderHeader) {
          folderHeader.addEventListener('click', () => toggleFolder(folderId));
        }
      }
    }

    // Save models to localStorage
    function saveModelsToLocalStorage() {
      localStorage.setItem('dashboardModels', JSON.stringify(models));
    }

    // Save folders to localStorage
    function saveFoldersToLocalStorage() {
      localStorage.setItem('dashboardFolders', JSON.stringify(folders));
    }

    // Save full screen state to localStorage
    function saveFullScreenState() {
      if (fullScreenModel) {
        localStorage.setItem('fullScreenModel', fullScreenModel);
      } else {
        localStorage.removeItem('fullScreenModel');
      }
    }

    // Initialize on load
    window.addEventListener('load', function() {
      // Check if mobile device
      if (/Mobi|Android/i.test(navigator.userAgent)) {
        document.body.classList.add('mobile');
      }
      
      initializeDashboard();
    });
  </script>
</body>
</html>