<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Advance Diamond</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Source+Sans+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    /* MODERN DASHBOARD STYLING */
    :root {
      --primary-color: #4361ee;
      --secondary-color: #3f37c9;
      --accent-color: #4895ef;
      --dark-color: #2b2d42;
      --light-color: #f8f9fa;
      --success-color: #4cc9f0;
      --warning-color: #f8961e;
      --danger-color: #f72585;
      --info-color: #7209b7;
      --border-radius: 12px;
      --box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
    }
    
    body {
      font-family: 'Source Sans Pro', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      margin: 0;
      padding: 0;
      color: var(--dark-color);
      min-height: 100vh;
    }
    
    h1, h2, h3, h4 {
      font-family: 'Montserrat', sans-serif;
      margin: 0 0 15px 0;
      color: var(--dark-color);
    }
    
    h1 {
      font-size: 2.2rem;
      font-weight: 700;
      color: var(--primary-color);
    }
    
    h2 {
      font-size: 1.6rem;
      font-weight: 600;
      color: var(--secondary-color);
      position: relative;
      padding-bottom: 10px;
    }
    
    h2::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 50px;
      height: 3px;
      background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
      border-radius: 3px;
    }
    
    .dashboard {
      max-width: 1400px;
      margin: 0 auto;
      padding: 25px;
    }
    
    .dashboard-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 25px;
      margin-top: 25px;
    }
    
    .panel {
      background: white;
      border-radius: var(--border-radius);
      padding: 25px;
      box-shadow: var(--box-shadow);
      transition: var(--transition);
      border: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .panel:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12);
    }
    
    /* Full width panels */
    #trendPanel, #multiTimeframePanel {
      grid-column: 1 / -1;
    }
    
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 15px;
      border-radius: var(--border-radius);
      overflow: hidden;
    }
    
    th, td {
      padding: 12px 15px;
      text-align: center;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    th {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 0.5px;
    }
    
    tr:last-child td {
      border-bottom: none;
    }
    
    tr:hover {
      background-color: rgba(67, 97, 238, 0.05);
    }
    
    .controls, .ranking-controls {
      margin-bottom: 25px;
      text-align: center;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      background: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }
    
    .controls select,
    .controls input,
    .controls button,
    .ranking-controls input,
    .ranking-controls button {
      padding: 12px 18px;
      font-size: 16px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      background: white;
      transition: var(--transition);
      font-family: 'Source Sans Pro', sans-serif;
    }
    
    .controls select {
      min-width: 180px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%234361ee' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 15px center;
      background-size: 12px;
      appearance: none;
      padding-right: 40px;
    }
    
    .controls input {
      min-width: 200px;
    }
    
    .controls button,
    .ranking-controls button {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      font-weight: 600;
      cursor: pointer;
      border: none;
      box-shadow: 0 4px 12px rgba(67, 97, 238, 0.2);
    }
    
    .controls button:hover,
    .ranking-controls button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(67, 97, 238, 0.3);
    }
    
    a.coin-link {
      text-decoration: none;
      color: var(--primary-color);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: inline-block;
    }
    
    a.coin-link:hover {
      color: var(--secondary-color);
      transform: translateX(3px);
    }
    
    /* MODAL STYLING */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal-content {
      background-color: white;
      margin: 5% auto;
      padding: 30px;
      border-radius: var(--border-radius);
      width: 90%;
      max-width: 900px;
      position: relative;
      box-shadow: 0 12px 36px rgba(0, 0, 0, 0.15);
      animation: slideUp 0.4s ease;
    }
    
    @keyframes slideUp {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .close {
      color: #aaa;
      position: absolute;
      top: 20px;
      right: 25px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .close:hover, .close:focus {
      color: var(--danger-color);
      transform: rotate(90deg);
    }
    
    .setting-item {
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .setting-item label {
      display: inline-block;
      width: 180px;
      font-weight: 600;
      color: var(--dark-color);
    }
    
    .setting-item input[type="number"] {
      padding: 10px 15px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      width: 80px;
      font-family: 'Source Sans Pro', sans-serif;
    }
    
    .advanced-setting {
      background-color: rgba(67, 97, 238, 0.05);
      padding: 20px;
      border-radius: var(--border-radius);
      margin-top: 25px;
      border-left: 4px solid var(--primary-color);
    }
    
    .highlight {
      border: 2px solid var(--danger-color);
      background-color: rgba(247, 37, 133, 0.05);
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(247, 37, 133, 0.2); }
      70% { box-shadow: 0 0 0 10px rgba(247, 37, 133, 0); }
      100% { box-shadow: 0 0 0 0 rgba(247, 37, 133, 0); }
    }
    
    /* HEADER STYLING */
    header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      position: relative;
      overflow: hidden;
    }
    
    header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background: linear-gradient(90deg, var(--primary-color), var(--accent-color), var(--success-color));
    }
    
    #updateTime {
      font-size: 0.9rem;
      color: #6c757d;
      font-weight: 500;
    }
    
    /* RESPONSIVE ADJUSTMENTS */
    @media (max-width: 768px) {
      .dashboard {
        padding: 15px;
      }
      
      h1 {
        font-size: 1.8rem;
      }
      
      h2 {
        font-size: 1.4rem;
      }
      
      .panel {
        padding: 20px;
      }
      
      .controls, .ranking-controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .controls select,
      .controls input,
      .controls button,
      .ranking-controls input,
      .ranking-controls button {
        width: 100%;
      }
    }
    
    /* ANIMATIONS */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .panel {
      animation: fadeInUp 0.6s ease forwards;
    }
    
    .panel:nth-child(1) { animation-delay: 0.1s; }
    .panel:nth-child(2) { animation-delay: 0.2s; }
    .panel:nth-child(3) { animation-delay: 0.3s; }
    .panel:nth-child(4) { animation-delay: 0.4s; }
    
    /* COLORFUL ROWS */
    #row-resistance3 { background-color: rgba(247, 37, 133, 0.1); }
    #row-midR3R2 { background-color: rgba(247, 37, 133, 0.08); }
    #row-resistance2 { background-color: rgba(248, 150, 30, 0.1); }
    #row-midR2R1 { background-color: rgba(248, 150, 30, 0.08); }
    #row-resistance1 { background-color: rgba(255, 193, 7, 0.1); }
    #row-midR1PP { background-color: rgba(255, 193, 7, 0.08); }
    #row-pivotPoint { background-color: rgba(76, 201, 240, 0.15); }
    #row-midPPS1 { background-color: rgba(76, 201, 240, 0.1); }
    #row-support1 { background-color: rgba(40, 167, 69, 0.1); }
    #row-midS1S2 { background-color: rgba(40, 167, 69, 0.08); }
    #row-support2 { background-color: rgba(0, 123, 255, 0.1); }
    #row-midS2S3 { background-color: rgba(0, 123, 255, 0.08); }
    #row-support3 { background-color: rgba(111, 66, 193, 0.1); }
    
    /* INDICATOR ROWS */
    #row-bollinger { background-color: rgba(108, 117, 125, 0.05); }
    #row-sma50 { background-color: rgba(108, 117, 125, 0.05); }
    #row-sma200 { background-color: rgba(108, 117, 125, 0.05); }
    #row-candlePattern { background-color: rgba(255, 193, 7, 0.05); }
    #row-mlPrediction { background-color: rgba(220, 53, 69, 0.05); }
    #row-sentiment { background-color: rgba(23, 162, 184, 0.05); }
    #row-riskMgmt { background-color: rgba(253, 126, 20, 0.05); }
    #row-adx { background-color: rgba(255, 193, 7, 0.1); }
    #row-ichimoku { background-color: rgba(40, 167, 69, 0.1); }
    #row-parabolic { background-color: rgba(253, 126, 20, 0.1); }
    #row-vwap { background-color: rgba(0, 123, 255, 0.1); }
    #row-orderFlow { background-color: rgba(111, 66, 193, 0.1); }
    #row-advMlPrediction { background-color: rgba(220, 53, 69, 0.1); }
    #row-ema8, #row-ema21, #row-ema50, #row-ema200 { background-color: rgba(108, 117, 125, 0.05); }
    #row-emaCross { background-color: rgba(255, 193, 7, 0.15); }
    
    /* LIVE PRICE ROW */
    #livePriceRow {
      background-color: rgba(76, 201, 240, 0.2) !important;
      font-weight: 700;
      color: var(--dark-color);
      animation: pulse 2s infinite;
    }
    
    /* ADDITIONAL ANALYSIS TABLE */
    #pivotPanel table:last-of-type {
      margin-top: 20px;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    #pivotPanel table:last-of-type th {
      background: linear-gradient(135deg, var(--accent-color), var(--success-color));
    }
    
    /* TREND ANALYSIS PANEL */
    #trendAnalysisContent table {
      margin-bottom: 20px;
    }
    
    #trendAnalysisContent th {
      background: linear-gradient(135deg, var(--accent-color), var(--info-color));
    }
    
    /* MULTI-TIMEFRAME PANEL */
    #multiTfContent table {
      background: transparent;
      box-shadow: none;
    }
    
    #multiTfContent td {
      vertical-align: top;
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 20px;
      margin: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: row;
      gap: 30px;
    }
    
    /* SETTINGS BUTTON */
    #pivotPanel > div:last-child button {
      background: linear-gradient(135deg, var(--accent-color), var(--info-color));
      padding: 12px 25px;
      border-radius: 8px;
      border: none;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: 0 4px 12px rgba(72, 149, 239, 0.3);
      font-family: 'Source Sans Pro', sans-serif;
      font-size: 16px;
    }
    
    #pivotPanel > div:last-child button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(72, 149, 239, 0.4);
    }
    
    /* SCROLLBAR STYLING */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.05);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--secondary-color);
    }

    .dashboard-container .panel{
        overflow: scroll;
        height: 2000px;
    }

       

    @media (max-width: 600px) {
       

         #multiTfContent td {
        vertical-align: top;
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        padding: 20px;
        margin: 10px;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
        flex-direction: row;
        gap: 30px;
        }

        .dashboard-container #rankingPanel{
        overflow: scroll;
        width: 85vw;
        height: 300px;
    }

    #pivotPanel{
      height: 100%;
    }
        
    }
  </style>
</head>
<body>
  <div class="dashboard">
    <!-- HEADER -->
    <header>
      <h1>Faisal's Diamond Advanced</h1>
      <p id="updateTime">Loading market data...</p>
    </header>
    
    <!-- MARKET TREND ANALYSIS PANEL -->
    <div class="panel" id="trendPanel">
      <h2>Market Trend Analysis</h2>
      <div id="trendAnalysisContent"></div>
    </div>
    
    <!-- MULTI-TIMEFRAME ANALYSIS PANEL -->
    <div class="panel" id="multiTimeframePanel">
      <h2>Multi-Timeframe Analysis</h2>
      <div id="multiTfContent"></div>
    </div>
    
    <!-- CONTROLS: COIN & TIMEFRAME SELECTION -->
    <div class="controls">
      <select id="coinSelector"></select>
      <select id="timeFrame">
        <option value="15m">15 Minutes</option>
        <option value="30m">30 Minutes</option>
        <option value="1h">1 Hour</option>
        <option value="4h">4 Hours</option>
        <option value="1d">1 Day</option>
        <option value="1w">1 Week</option>
        <option value="1M">1 Month</option>
      </select>
      <input type="text" id="coinSearch" placeholder="Search coin..." />
      <button onclick="searchCoin()">Search</button>
    </div>
    
    <div class="dashboard-container">
      <!-- RANKING PANEL -->
      <div class="panel" id="rankingPanel">
        <h2>ALL USDT Perpetual Coins</h2>
        <div class="ranking-controls">
          <input type="text" id="rankingSearch" placeholder="Search in ranking..." />
          <button onclick="filterRanking()">Search</button>
        </div>
        <table>
          <thead>
            <tr>
              <th id="th-rank" onclick="sortRanking('rank')">Rank</th>
              <th id="th-coin" onclick="sortRanking('coin')">Coin</th>
              <th id="th-live" onclick="sortRanking('live')">Live Price</th>
            </tr>
          </thead>
          <tbody id="rankingTableBody"></tbody>
        </table>
      </div>
    
      <!-- MAIN ANALYSIS PANEL -->
      <div class="panel" id="pivotPanel">
        <h2>GOLD Advanced Calculation</h2>
        <table>
          <thead>
            <tr>
              <th>Indicator</th>
              <th>Value</th>
              <th>Analysis</th>
            </tr>
          </thead>
          <tbody>
            <!-- Pivot & Support/Resistance Rows -->
            <tr id="row-resistance3">
              <td>Resistance 3</td><td id="resistance3">-</td><td id="ai-resistance3">-</td>
            </tr>
            <tr id="row-midR3R2">
              <td>Mid (R3-R2)</td><td id="midR3R2">-</td><td id="ai-midR3R2">-</td>
            </tr>
            <tr id="row-resistance2">
              <td>Resistance 2</td><td id="resistance2">-</td><td id="ai-resistance2">-</td>
            </tr>
            <tr id="row-midR2R1">
              <td>Mid (R2-R1)</td><td id="midR2R1">-</td><td id="ai-midR2R1">-</td>
            </tr>
            <tr id="row-resistance1">
              <td>Resistance 1</td><td id="resistance1">-</td><td id="ai-resistance1">-</td>
            </tr>
            <tr id="row-midR1PP">
              <td>Mid (R1-PP)</td><td id="midR1PP">-</td><td id="ai-midR1PP">-</td>
            </tr>
            <tr id="row-pivotPoint">
              <td>Pivot Point</td><td id="pivotPoint">-</td><td id="ai-pivotPoint">-</td>
            </tr>
            <tr id="row-midPPS1">
              <td>Mid (PP-S1)</td><td id="midPPS1">-</td><td id="ai-midPPS1">-</td>
            </tr>
            <tr id="row-support1">
              <td>Support 1</td><td id="support1">-</td><td id="ai-support1">-</td>
            </tr>
            <tr id="row-midS1S2">
              <td>Mid (S1-S2)</td><td id="midS1S2">-</td><td id="ai-midS1S2">-</td>
            </tr>
            <tr id="row-support2">
              <td>Support 2</td><td id="support2">-</td><td id="ai-support2">-</td>
            </tr>
            <tr id="row-midS2S3">
              <td>Mid (S2-S3)</td><td id="midS2S3">-</td><td id="ai-midS2S3">-</td>
            </tr>
            <tr id="row-support3">
              <td>Support 3</td><td id="support3">-</td><td id="ai-support3">-</td>
            </tr>
            <!-- Additional Indicators -->
            <tr id="row-bollinger">
              <td>Bollinger Bands</td><td id="bollinger">-</td><td id="ai-bollinger">-</td>
            </tr>
            <!-- 4 EMA Rows -->
            <tr id="row-ema8">
              <td>EMA 1</td><td id="ema8">-</td><td id="ai-ema8">-</td>
            </tr>
            <tr id="row-ema21">
              <td>EMA 2</td><td id="ema21">-</td><td id="ai-ema21">-</td>
            </tr>
            <tr id="row-ema50">
              <td>EMA 3</td><td id="ema50">-</td><td id="ai-ema50">-</td>
            </tr>
            <tr id="row-ema200">
              <td>EMA 4</td><td id="ema200">-</td><td id="ai-ema200">-</td>
            </tr>
            <tr id="row-emaCross">
              <td>EMA Crossover Prediction</td>
              <td id="emaCrossValue">-</td>
              <td id="ai-emaCross">-</td>
            </tr>


            <tr id="row-sma50">
              <td>SMA50</td><td id="sma50">-</td><td id="ai-sma50">-</td>
            </tr>
            <tr id="row-sma200">
              <td>SMA200</td><td id="sma200">-</td><td id="ai-sma200">-</td>
            </tr>
            <tr id="row-candlePattern">
              <td>Candlestick Pattern</td><td id="candlePattern">-</td><td id="ai-candlePattern">-</td>
            </tr>
            <tr id="row-mlPrediction">
              <td>ML Prediction</td><td id="mlPrediction">-</td><td id="ai-mlPrediction">-</td>
            </tr>
            <tr id="row-sentiment">
              <td>Sentiment Analysis</td><td id="sentiment">-</td><td id="ai-sentiment">-</td>
            </tr>
            <tr id="row-riskMgmt">
              <td>Risk Management</td><td id="riskMgmt">-</td><td id="ai-riskMgmt">-</td>
            </tr>
            <!-- Advanced Indicators -->
            <tr id="row-adx">
              <td>ADX</td><td id="adx">-</td><td id="ai-adx">-</td>
            </tr>
            <tr id="row-ichimoku">
              <td>Ichimoku Cloud</td><td id="ichimoku">-</td><td id="ai-ichimoku">-</td>
            </tr>
            <tr id="row-parabolic">
              <td>Parabolic SAR</td><td id="parabolic">-</td><td id="ai-parabolic">-</td>
            </tr>
            <tr id="row-vwap">
              <td>VWAP</td><td id="vwap">-</td><td id="ai-vwap">-</td>
            </tr>
            <tr id="row-orderFlow">
              <td>Order Flow</td><td id="orderFlow">-</td><td id="ai-orderFlow">-</td>
            </tr>
            <tr id="row-advMlPrediction">
              <td>Advanced ML Prediction</td><td id="advMlPrediction">-</td><td id="ai-advMlPrediction">-</td>
            </tr>
            <!-- Live Price Row (Inserted dynamically) -->
          </tbody>
        </table>
        <!-- Additional Analysis Section for New Features -->
        <table>
          <thead>
            <tr>
              <th>Additional Indicator</th>
              <th>Value</th>
              <th>Analysis</th>
            </tr>
          </thead>
          <tbody>
            <tr id="row-orderBookDepth">
              <td>Order Book Depth</td>
              <td id="orderBookDepth">-</td>
              <td id="ai-orderBookDepth">-</td>
            </tr>
            <tr id="row-orderFlowNew">
              <td>Order Flow Analysis</td>
              <td id="orderFlowNew">-</td>
              <td id="ai-orderFlowNew">-</td>
            </tr>
            <tr id="row-volumeProfile">
              <td>Volume Profile (CVP)</td>
              <td id="volumeProfile">-</td>
              <td id="ai-volumeProfile">-</td>
            </tr>
            <tr id="row-riskReward">
              <td>Risk/Reward Ratio</td>
              <td id="riskReward">-</td>
              <td id="ai-riskReward">-</td>
            </tr>
            <tr id="row-rVol">
              <td>Relative Volume (rVol)</td>
              <td id="rVol">-</td>
              <td id="ai-rVol">-</td>
            </tr>
          </tbody>
        </table>
        <div style="text-align: center; margin-top: 20px;">
          <button onclick="openSettings()">Settings</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- SETTINGS MODAL -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeSettings()">&times;</span>
      <h3>Customize Indicator Parameters & Colors</h3>
      
      <!-- Indicator Parameter Settings -->
      <div class="setting-item">
        <label>EMA Period 1:</label>
        <input type="number" id="param-ema1" value="8" onchange="saveParam('ema1', this.value)">
      </div>
      <div class="setting-item">
        <label>EMA Period 2:</label>
        <input type="number" id="param-ema2" value="21" onchange="saveParam('ema2', this.value)">
      </div>
      <div class="setting-item">
        <label>EMA Period 3:</label>
        <input type="number" id="param-ema3" value="50" onchange="saveParam('ema3', this.value)">
      </div>
      <div class="setting-item">
        <label>EMA Period 4:</label>
        <input type="number" id="param-ema4" value="200" onchange="saveParam('ema4', this.value)">
      </div>
      
      <div class="advanced-setting">
        <h4>Advanced Indicator Parameters</h4>
        <div class="setting-item">
          <label>RSI Period:</label>
          <input type="number" id="param-rsi" value="14" onchange="saveParam('rsi', this.value)">
        </div>
        <div class="setting-item">
          <label>Bollinger Period:</label>
          <input type="number" id="param-bollinger" value="20" onchange="saveParam('bollinger', this.value)">
        </div>
        <div class="setting-item">
          <label>ADX Period:</label>
          <input type="number" id="param-adx" value="14" onchange="saveParam('adx', this.value)">
        </div>
      </div>
      
      <!-- Color Settings for Selected Indicators -->
      <div class="advanced-setting">
        <h4>Color Settings (Selected Indicators)</h4>
        <div class="setting-item">
          <label>Resistance 3 BG:</label>
          <input type="color" id="bg-resistance3" value="#FF6666" onchange="updateRowColor('resistance3')">
          <label>Font:</label>
          <input type="color" id="font-resistance3" value="#000000" onchange="updateRowColor('resistance3')">
        </div>
        <div class="setting-item">
          <label>Pivot Point BG:</label>
          <input type="color" id="bg-pivotPoint" value="#66FF66" onchange="updateRowColor('pivotPoint')">
          <label>Font:</label>
          <input type="color" id="font-pivotPoint" value="#000000" onchange="updateRowColor('pivotPoint')">
        </div>
        <div class="setting-item">
          <label>EMA 1 BG:</label>
          <input type="color" id="bg-ema8" value="#D3D3D3" onchange="updateRowColor('ema8')">
          <label>Font:</label>
          <input type="color" id="font-ema8" value="#000000" onchange="updateRowColor('ema8')">
        </div>
        <div class="setting-item">
          <label>EMA Crossover BG:</label>
          <input type="color" id="bg-emaCross" value="#F0E68C" onchange="updateRowColor('emaCross')">
          <label>Font:</label>
          <input type="color" id="font-emaCross" value="#000000" onchange="updateRowColor('emaCross')">
        </div>
        <div class="setting-item">
          <label>Live Price BG:</label>
          <input type="color" id="bg-livePrice" value="#d1ecf1" onchange="updateLivePriceColor()">
          <label>Font:</label>
          <input type="color" id="font-livePrice" value="#0c5460" onchange="updateLivePriceColor()">
        </div>
      </div>
      
      <!-- Color Settings for All Indicators -->
      <div class="advanced-setting">
        <h4>Color Settings for All Indicators</h4>
        <div class="setting-item">
          <label>Resistance 2 BG:</label>
          <input type="color" id="bg-resistance2" value="#FFCC66" onchange="updateRowColor('resistance2')">
          <label>Font:</label>
          <input type="color" id="font-resistance2" value="#000000" onchange="updateRowColor('resistance2')">
        </div>
        <div class="setting-item">
          <label>Resistance 1 BG:</label>
          <input type="color" id="bg-resistance1" value="#FFFF66" onchange="updateRowColor('resistance1')">
          <label>Font:</label>
          <input type="color" id="font-resistance1" value="#000000" onchange="updateRowColor('resistance1')">
        </div>
        <div class="setting-item">
          <label>Mid (R3-R2) BG:</label>
          <input type="color" id="bg-midR3R2" value="#FF9966" onchange="updateRowColor('midR3R2')">
          <label>Font:</label>
          <input type="color" id="font-midR3R2" value="#000000" onchange="updateRowColor('midR3R2')">
        </div>
        <div class="setting-item">
          <label>Mid (R2-R1) BG:</label>
          <input type="color" id="bg-midR2R1" value="#FFE066" onchange="updateRowColor('midR2R1')">
          <label>Font:</label>
          <input type="color" id="font-midR2R1" value="#000000" onchange="updateRowColor('midR2R1')">
        </div>
        <div class="setting-item">
          <label>Mid (R1-PP) BG:</label>
          <input type="color" id="bg-midR1PP" value="#CCFF66" onchange="updateRowColor('midR1PP')">
          <label>Font:</label>
          <input type="color" id="font-midR1PP" value="#000000" onchange="updateRowColor('midR1PP')">
        </div>
        <div class="setting-item">
          <label>Mid (PP-S1) BG:</label>
          <input type="color" id="bg-midPPS1" value="#66FFCC" onchange="updateRowColor('midPPS1')">
          <label>Font:</label>
          <input type="color" id="font-midPPS1" value="#000000" onchange="updateRowColor('midPPS1')">
        </div>
        <div class="setting-item">
          <label>Support 1 BG:</label>
          <input type="color" id="bg-support1" value="#66FFFF" onchange="updateRowColor('support1')">
          <label>Font:</label>
          <input type="color" id="font-support1" value="#000000" onchange="updateRowColor('support1')">
        </div>
        <div class="setting-item">
          <label>Mid (S1-S2) BG:</label>
          <input type="color" id="bg-midS1S2" value="#66CCFF" onchange="updateRowColor('midS1S2')">
          <label>Font:</label>
          <input type="color" id="font-midS1S2" value="#000000" onchange="updateRowColor('midS1S2')">
        </div>
        <div class="setting-item">
          <label>Support 2 BG:</label>
          <input type="color" id="bg-support2" value="#6699FF" onchange="updateRowColor('support2')">
          <label>Font:</label>
          <input type="color" id="font-support2" value="#000000" onchange="updateRowColor('support2')">
        </div>
        <div class="setting-item">
          <label>Mid (S2-S3) BG:</label>
          <input type="color" id="bg-midS2S3" value="#9966FF" onchange="updateRowColor('midS2S3')">
          <label>Font:</label>
          <input type="color" id="font-midS2S3" value="#000000" onchange="updateRowColor('midS2S3')">
        </div>
        <div class="setting-item">
          <label>Support 3 BG:</label>
          <input type="color" id="bg-support3" value="#CC66FF" onchange="updateRowColor('support3')">
          <label>Font:</label>
          <input type="color" id="font-support3" value="#000000" onchange="updateRowColor('support3')">
        </div>
        <div class="setting-item">
          <label>Bollinger Bands BG:</label>
          <input type="color" id="bg-bollinger" value="#E8EAF6" onchange="updateRowColor('bollinger')">
          <label>Font:</label>
          <input type="color" id="font-bollinger" value="#000000" onchange="updateRowColor('bollinger')">
        </div>
        <div class="setting-item">
          <label>SMA50 BG:</label>
          <input type="color" id="bg-sma50" value="#E0F7FA" onchange="updateRowColor('sma50')">
          <label>Font:</label>
          <input type="color" id="font-sma50" value="#000000" onchange="updateRowColor('sma50')">
        </div>
        <div class="setting-item">
          <label>SMA200 BG:</label>
          <input type="color" id="bg-sma200" value="#E8F5E9" onchange="updateRowColor('sma200')">
          <label>Font:</label>
          <input type="color" id="font-sma200" value="#000000" onchange="updateRowColor('sma200')">
        </div>
        <div class="setting-item">
          <label>Candlestick Pattern BG:</label>
          <input type="color" id="bg-candlePattern" value="#FFF3E0" onchange="updateRowColor('candlePattern')">
          <label>Font:</label>
          <input type="color" id="font-candlePattern" value="#000000" onchange="updateRowColor('candlePattern')">
        </div>
        <div class="setting-item">
          <label>ML Prediction BG:</label>
          <input type="color" id="bg-mlPrediction" value="#F3E5F5" onchange="updateRowColor('mlPrediction')">
          <label>Font:</label>
          <input type="color" id="font-mlPrediction" value="#000000" onchange="updateRowColor('mlPrediction')">
        </div>
        <div class="setting-item">
          <label>Sentiment Analysis BG:</label>
          <input type="color" id="bg-sentiment" value="#ECEFF1" onchange="updateRowColor('sentiment')">
          <label>Font:</label>
          <input type="color" id="font-sentiment" value="#000000" onchange="updateRowColor('sentiment')">
        </div>
        <div class="setting-item">
          <label>Risk Management BG:</label>
          <input type="color" id="bg-riskMgmt" value="#FFEBEE" onchange="updateRowColor('riskMgmt')">
          <label>Font:</label>
          <input type="color" id="font-riskMgmt" value="#000000" onchange="updateRowColor('riskMgmt')">
        </div>
        <div class="setting-item">
          <label>ADX BG:</label>
          <input type="color" id="bg-adx" value="#FFD700" onchange="updateRowColor('adx')">
          <label>Font:</label>
          <input type="color" id="font-adx" value="#000000" onchange="updateRowColor('adx')">
        </div>
        <div class="setting-item">
          <label>Ichimoku Cloud BG:</label>
          <input type="color" id="bg-ichimoku" value="#ADFF2F" onchange="updateRowColor('ichimoku')">
          <label>Font:</label>
          <input type="color" id="font-ichimoku" value="#000000" onchange="updateRowColor('ichimoku')">
        </div>
        <div class="setting-item">
          <label>Parabolic SAR BG:</label>
          <input type="color" id="bg-parabolic" value="#FF8C00" onchange="updateRowColor('parabolic')">
          <label>Font:</label>
          <input type="color" id="font-parabolic" value="#000000" onchange="updateRowColor('parabolic')">
        </div>
        <div class="setting-item">
          <label>VWAP BG:</label>
          <input type="color" id="bg-vwap" value="#87CEEB" onchange="updateRowColor('vwap')">
          <label>Font:</label>
          <input type="color" id="font-vwap" value="#000000" onchange="updateRowColor('vwap')">
        </div>
        <div class="setting-item">
          <label>Order Flow BG:</label>
          <input type="color" id="bg-orderFlow" value="#DDA0DD" onchange="updateRowColor('orderFlow')">
          <label>Font:</label>
          <input type="color" id="font-orderFlow" value="#000000" onchange="updateRowColor('orderFlow')">
        </div>
        <div class="setting-item">
          <label>Advanced ML Prediction BG:</label>
          <input type="color" id="bg-advMlPrediction" value="#FFC0CB" onchange="updateRowColor('advMlPrediction')">
          <label>Font:</label>
          <input type="color" id="font-advMlPrediction" value="#000000" onchange="updateRowColor('advMlPrediction')">
        </div>
        <div class="setting-item">
          <label>EMA 2 (21) BG:</label>
          <input type="color" id="bg-ema21" value="#D3D3D3" onchange="updateRowColor('ema21')">
          <label>Font:</label>
          <input type="color" id="font-ema21" value="#000000" onchange="updateRowColor('ema21')">
        </div>
        <div class="setting-item">
          <label>EMA 3 (50) BG:</label>
          <input type="color" id="bg-ema50" value="#D3D3D3" onchange="updateRowColor('ema50')">
          <label>Font:</label>
          <input type="color" id="font-ema50" value="#000000" onchange="updateRowColor('ema50')">
        </div>
        <div class="setting-item">
          <label>EMA 4 (200) BG:</label>
          <input type="color" id="bg-ema200" value="#D3D3D3" onchange="updateRowColor('ema200')">
          <label>Font:</label>
          <input type="color" id="font-ema200" value="#000000" onchange="updateRowColor('ema200')">
        </div>
      </div>
    </div>
  </div>
  
  <!-- JAVASCRIPT SECTION -->
  <script>
    /*************** GLOBAL VARIABLES & DEFAULT PARAMETERS ****************/
    let tickerWS;
    let allCoins = [];
    let fetchedRankingData = [];
    let globalRankMapping = {};
    let currentSortField = 'rank';
    let currentSortDir = 'desc';
    // live price variable â€“ updated each call from API data
    let latestLivePrice = 0;
    let lastClosedEma1 = 0, lastClosedEma2 = 0, lastClosedEma3 = 0, lastClosedEma4 = 0;
    let prevLiveEma1 = null, prevLiveEma2 = null;
    
    // Default parameters
    let params = {
      ema1: 8,
      ema2: 21,
      ema3: 50,
      ema4: 200,
      rsi: 14,
      bollinger: 20,
      adx: 14
    };

    /*************** LOCAL STORAGE FUNCTIONS ***************/
    function saveParam(key, value) {
      params[key] = parseInt(value);
      localStorage.setItem('param-' + key, value);
    }
    function loadParams() {
      for (let key in params) {
        let stored = localStorage.getItem('param-' + key);
        if (stored) {
          params[key] = parseInt(stored);
          let elem = document.getElementById('param-' + key);
          if (elem) elem.value = stored;
        }
      }
    }
    function saveColorSetting(key, type, value) {
      localStorage.setItem(type + "-" + key, value);
    }
    function loadColorSetting(key, type, defaultVal) {
      return localStorage.getItem(type + "-" + key) || defaultVal;
    }
    function updateRowColor(rowKey) {
      const bgColorEl = document.getElementById("bg-" + rowKey);
      const fontColorEl = document.getElementById("font-" + rowKey);
      if(!bgColorEl || !fontColorEl) return;
      const bgColor = bgColorEl.value;
      const fontColor = fontColorEl.value;
      const rowElement = document.getElementById("row-" + rowKey);
      if (rowElement) {
        rowElement.style.backgroundColor = bgColor;
        rowElement.style.color = fontColor;
      }
      saveColorSetting(rowKey, "bg", bgColor);
      saveColorSetting(rowKey, "font", fontColor);
    }
    function updateLivePriceColor() {
      const bgEl = document.getElementById("bg-livePrice");
      const fontEl = document.getElementById("font-livePrice");
      if(!bgEl || !fontEl) return;
      const bgColor = bgEl.value;
      const fontColor = fontEl.value;
      const liveRow = document.getElementById("livePriceRow");
      if (liveRow) {
        liveRow.style.backgroundColor = bgColor;
        liveRow.style.color = fontColor;
      }
      saveColorSetting("livePrice", "bg", bgColor);
      saveColorSetting("livePrice", "font", fontColor);
    }
    function loadColorSettings() {
      const rowKeys = [
        "resistance3","midR3R2","resistance2","midR2R1","resistance1","midR1PP","pivotPoint",
        "midPPS1","support1","midS1S2","support2","midS2S3","support3",
        "bollinger","sma50","sma200","candlePattern","mlPrediction","sentiment","riskMgmt",
        "adx","ichimoku","parabolic","vwap","orderFlow","advMlPrediction",
        "ema8","ema21","ema50","ema200","emaCross","livePrice"
      ];
      rowKeys.forEach(key => {
        const bgEl = document.getElementById("bg-" + key);
        const fontEl = document.getElementById("font-" + key);
        if(bgEl && fontEl) {
          const storedBG = loadColorSetting(key, "bg", bgEl.value);
          const storedFont = loadColorSetting(key, "font", fontEl.value);
          bgEl.value = storedBG;
          fontEl.value = storedFont;
          if(key === "livePrice") {
            updateLivePriceColor();
          } else {
            updateRowColor(key);
          }
        }
      });
    }
    
    /*************** INDICATOR CALCULATIONS ***************/
    function calculateATR(candles, period) {
      let trs = [];
      for (let i = 1; i < candles.length; i++) {
        let current = candles[i];
        let previous = candles[i - 1];
        let high = parseFloat(current[2]);
        let low = parseFloat(current[3]);
        let prevClose = parseFloat(previous[4]);
        let tr = Math.max(high - low, Math.abs(high - prevClose), Math.abs(low - prevClose));
        trs.push(tr);
      }
      let periodTrs = trs.slice(-period);
      return periodTrs.reduce((a, b) => a + b, 0) / periodTrs.length;
    }
    function calculateRSI(candles, period) {
      if(candles.length < period+1) return 50;
      let gains = 0, losses = 0;
      for (let i = candles.length - period; i < candles.length; i++) {
        let change = parseFloat(candles[i][4]) - parseFloat(candles[i - 1][4]);
        if (change >= 0) gains += change; else losses += Math.abs(change);
      }
      let avgGain = gains / period;
      let avgLoss = losses / period;
      let rs = (avgLoss === 0) ? 100 : avgGain / avgLoss;
      return 100 - (100 / (1 + rs));
    }
    function calculateEMA(values, period) {
      if(!values.length) return 0;
      let k = 2 / (period + 1);
      let ema = values[0];
      for (let i = 1; i < values.length; i++) {
        ema = values[i] * k + ema * (1 - k);
      }
      return ema;
    }
    function calculateMACD(candles) {
      if(!candles.length) return 0;
      let closes = candles.map(c => parseFloat(c[4]));
      let ema12 = calculateEMA(closes, 12);
      let ema26 = calculateEMA(closes, 26);
      return ema12 - ema26;
    }
    function calculateBollingerBands(candles, period = params.bollinger, multiplier = 2) {
      let closes = candles.map(c => parseFloat(c[4]));
      if (closes.length < period) return { middle: 0, upper: 0, lower: 0 };
      let recent = closes.slice(-period);
      let middle = recent.reduce((a, b) => a + b, 0) / period;
      let variance = recent.map(price => Math.pow(price - middle, 2)).reduce((a, b) => a + b, 0) / period;
      let stdDev = Math.sqrt(variance);
      return { middle, upper: middle + multiplier * stdDev, lower: middle - multiplier * stdDev };
    }
    function calculateSMA(values, period) {
      if (values.length < period) return 0;
      let recent = values.slice(-period);
      return recent.reduce((a, b) => a + b, 0) / period;
    }
    function detectCandlestickPattern(candle) {
      if(!candle) return "No pattern";
      let open = parseFloat(candle[1]), close = parseFloat(candle[4]);
      let high = parseFloat(candle[2]), low = parseFloat(candle[3]);
      let bodySize = Math.abs(close - open);
      let range = high - low;
      if (range === 0) return "No pattern";
      return (bodySize / range < 0.1) ? "Doji pattern detected" : "Normal candle";
    }
    function predictMarketCrash(features) {
      let score = 0;
      if (features.rsi > 70) score += 20;
      if (features.atr > features.pivot * 0.02) score += 15;
      if (features.macd < 0) score += 15;
      if (features.volumeSpike) score += 20;
      if (features.candlePattern === "Doji pattern detected") score += 10;
      return score;
    }
    function getSentimentScore() {
      let score = Math.random() * 100;
      if (score > 60) return { sentiment: "Bearish", score: score.toFixed(2) };
      if (score < 40) return { sentiment: "Bullish", score: score.toFixed(2) };
      return { sentiment: "Neutral", score: score.toFixed(2) };
    }
    function riskManagementRecommendation(features) {
      let stopLoss = features.pivot - 1.5 * features.atr;
      let targetProfit = features.pivot + 1.5 * features.atr;
      return { stopLoss: stopLoss.toFixed(2), targetProfit: targetProfit.toFixed(2) };
    }
    function calculateADX(candles, period = params.adx) {
      if(candles.length < period+1) return 0;
      let trs = [], pdms = [], ndms = [];
      for (let i = 1; i < candles.length; i++) {
        const current = candles[i], prev = candles[i - 1];
        const high = parseFloat(current[2]), low = parseFloat(current[3]);
        const tr = Math.max(high - low, Math.abs(high - parseFloat(prev[4])), Math.abs(low - parseFloat(prev[4])));
        trs.push(tr);
        const pDM = parseFloat(current[2]) - parseFloat(prev[2]);
        const nDM = parseFloat(prev[3]) - parseFloat(current[3]);
        pdms.push((pDM > nDM && pDM > 0) ? pDM : 0);
        ndms.push((nDM > pDM && nDM > 0) ? nDM : 0);
      }
      let atr = trs.slice(-period).reduce((a, b) => a + b, 0) / period;
      let pDM_avg = pdms.slice(-period).reduce((a, b) => a + b, 0) / period;
      let nDM_avg = ndms.slice(-period).reduce((a, b) => a + b, 0) / period;
      let pDI = (pDM_avg / atr) * 100;
      let nDI = (nDM_avg / atr) * 100;
      let dx = (Math.abs(pDI - nDI) / (pDI + nDI)) * 100;
      return dx.toFixed(2);
    }
    function calculateIchimoku(candles) {
      const periodTenkan = 9, periodKijun = 26, periodSenkou = 52;
      if (candles.length < periodSenkou) return { tenkan: 0, kijun: 0, senkouA: 0, senkouB: 0 };
      let recentTenkan = candles.slice(-periodTenkan);
      let recentKijun = candles.slice(-periodKijun);
      let recentSenkou = candles.slice(-periodSenkou);
      const tenkan = (Math.max(...recentTenkan.map(c => parseFloat(c[2]))) + Math.min(...recentTenkan.map(c => parseFloat(c[3])))) / 2;
      const kijun = (Math.max(...recentKijun.map(c => parseFloat(c[2]))) + Math.min(...recentKijun.map(c => parseFloat(c[3])))) / 2;
      const senkouA = (tenkan + kijun) / 2;
      const senkouB = (Math.max(...recentSenkou.map(c => parseFloat(c[2]))) + Math.min(...recentSenkou.map(c => parseFloat(c[3])))) / 2;
      return {
        tenkan: tenkan.toFixed(2),
        kijun: kijun.toFixed(2),
        senkouA: senkouA.toFixed(2),
        senkouB: senkouB.toFixed(2)
      };
    }
    function calculateParabolicSAR(candles) {
      if(candles.length < 2) return 0;
      let lastCandle = candles[candles.length - 2];
      let high = parseFloat(lastCandle[2]), low = parseFloat(lastCandle[3]), close = parseFloat(lastCandle[4]);
      return (close + (high - low) * 0.02).toFixed(2);
    }
    function calculateVWAP(candles) {
      if(!candles.length) return 0;
      let cumulativeTPV = 0, cumulativeVolume = 0;
      candles.forEach(c => {
        let high = parseFloat(c[2]), low = parseFloat(c[3]), close = parseFloat(c[4]), volume = parseFloat(c[5]);
        let typicalPrice = (high + low + close) / 3;
        cumulativeTPV += typicalPrice * volume;
        cumulativeVolume += volume;
      });
      if(cumulativeVolume === 0) return 0;
      return (cumulativeTPV / cumulativeVolume).toFixed(2);
    }
    function advancedMLPrediction(features) {
      const adx = parseFloat(calculateADX(features.candles));
      const vwap = parseFloat(calculateVWAP(features.candles));
      let signal = "HOLD";
      if (features.rsi > 50 && adx > 25 && latestLivePrice > vwap) {
        signal = "STRONG BUY";
      } else if (features.rsi < 50 && adx > 25 && latestLivePrice < vwap) {
        signal = "STRONG SELL";
      }
      return signal;
    }

    /*************** ADDITIONAL ANALYSIS FUNCTIONS (NEW FEATURES) ***************/
    async function updateAdditionalAnalysis(symbol) {
      if(!symbol) return;
      try {
        let orderBookResponse = await fetch(`https://fapi.binance.com/fapi/v1/depth?symbol=${symbol}&limit=10`);
        let orderBookData = await orderBookResponse.json();
        if(orderBookData.bids && orderBookData.asks) {
          let bids = orderBookData.bids;
          let asks = orderBookData.asks;
          let totalBidVolume = bids.reduce((sum, b) => sum + parseFloat(b[1]), 0);
          let totalAskVolume = asks.reduce((sum, a) => sum + parseFloat(a[1]), 0);
          let denom = (totalBidVolume + totalAskVolume) || 1;
          let orderBookDepthMetric = ((totalBidVolume - totalAskVolume) / denom).toFixed(2);
          document.getElementById("orderBookDepth").textContent = orderBookDepthMetric;
          let aiOrderBook = orderBookDepthMetric > 0 ? "Buying Pressure" : (orderBookDepthMetric < 0 ? "Selling Pressure" : "Neutral");
          document.getElementById("ai-orderBookDepth").textContent = aiOrderBook;
        }
      } catch (err) {
        console.error("Order Book Depth fetch error:", err);
      }
      
      let buyFlow = Math.random() * 100;
      let orderFlowMetric = buyFlow.toFixed(2);
      document.getElementById("orderFlowNew").textContent = orderFlowMetric;
      let aiOrderFlow = buyFlow > 50 ? "Strong Buy Flow" : (buyFlow < 50 ? "Strong Sell Flow" : "Neutral");
      document.getElementById("ai-orderFlowNew").textContent = aiOrderFlow;
      
      try {
        let timeframe = document.getElementById("timeFrame").value || "15m";
        let candleResponse = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=${timeframe}&limit=50`);
        let candleData = await candleResponse.json();
        if(Array.isArray(candleData) && candleData.length) {
          let totalVP = 0, totalVolume = 0;
          candleData.forEach(c => {
            let high = parseFloat(c[2]), low = parseFloat(c[3]), close = parseFloat(c[4]), volume = parseFloat(c[5]);
            let typicalPrice = (high + low + close) / 3;
            totalVP += typicalPrice * volume;
            totalVolume += volume;
          });
          let cvp = totalVolume ? (totalVP / totalVolume).toFixed(2) : 0;
          document.getElementById("volumeProfile").textContent = cvp;
          let aiVolumeProfile = cvp ? "CVP indicates accumulation at " + cvp : "N/A";
          document.getElementById("ai-volumeProfile").textContent = aiVolumeProfile;
          
          if(candleData.length >= 2) {
            let secondLast = candleData[candleData.length - 2];
            let high = parseFloat(secondLast[2]), low = parseFloat(secondLast[3]), close = parseFloat(secondLast[4]);
            let denom = (close - low);
            let riskReward = denom > 0 ? ((high - close) / denom).toFixed(2) : "N/A";
            document.getElementById("riskReward").textContent = riskReward;
            let aiRiskReward = (riskReward !== "N/A") ? (riskReward >= 1 ? "Favorable" : "Unfavorable") : "N/A";
            document.getElementById("ai-riskReward").textContent = aiRiskReward;
          }
          
          if(candleData.length >= 16) {
            let sliceCandles = candleData.slice(candleData.length - 16, candleData.length - 1);
            let totalVol = sliceCandles.reduce((sum, c) => sum + parseFloat(c[5]), 0);
            let avgVol = totalVol / sliceCandles.length;
            let currentVol = parseFloat(candleData[candleData.length - 1][5]) || 0;
            let rVolValue = (avgVol && avgVol > 0) ? (currentVol / avgVol).toFixed(2) : "N/A";
            document.getElementById("rVol").textContent = rVolValue;
            let aiRVol = rVolValue !== "N/A" ? (rVolValue > 1 ? "High Volume" : "Normal") : "N/A";
            document.getElementById("ai-rVol").textContent = aiRVol;
          }
        }
      } catch (err) {
        console.error("Candle data fetch error for additional analysis:", err);
      }
    }
    
    /*************** CORE FUNCTION: UPDATE PIVOT & TRADING SIGNALS ***************/
    async function updatePivotAndTradingSignals(symbol) {
      if(!symbol) return;
      const timeFrame = document.getElementById("timeFrame").value || "15m";
      try {
        let data = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=${timeFrame}&limit=50`)
          .then(res => res.json());
        if (!Array.isArray(data) || data.length < 2) return;
    
        // Update live price from the last candle's close so live value stays as before
        latestLivePrice = parseFloat(data[data.length - 1][4]);
    
        let pivotCandle = data[data.length - 2];
        let high = parseFloat(pivotCandle[2]), low = parseFloat(pivotCandle[3]), close = parseFloat(pivotCandle[4]);
        let pivot = (high + low + close) / 3;
        let s1 = pivot * 2 - high;
        let s2 = pivot - (high - low);
        let s3 = low - 2 * (high - pivot);
        let r1 = pivot * 2 - low;
        let r2 = pivot + (high - low);
        let r3 = high + 2 * (pivot - low);
    
        document.getElementById("pivotPoint").textContent = pivot.toFixed(7);
        document.getElementById("support1").textContent = s1.toFixed(7);
        document.getElementById("support2").textContent = s2.toFixed(7);
        document.getElementById("support3").textContent = s3.toFixed(7);
        document.getElementById("resistance1").textContent = r1.toFixed(7);
        document.getElementById("resistance2").textContent = r2.toFixed(7);
        document.getElementById("resistance3").textContent = r3.toFixed(7);
        document.getElementById("midR3R2").textContent = ((r3 + r2) / 2).toFixed(7);
        document.getElementById("midR2R1").textContent = ((r2 + r1) / 2).toFixed(7);
        document.getElementById("midR1PP").textContent  = ((r1 + pivot) / 2).toFixed(7);
        document.getElementById("midPPS1").textContent  = ((pivot + s1) / 2).toFixed(7);
        document.getElementById("midS1S2").textContent  = ((s1 + s2) / 2).toFixed(7);
        document.getElementById("midS2S3").textContent  = ((s2 + s3) / 2).toFixed(7);
        updateTime();
    
        let atr = calculateATR(data, 14);
        let rsi = calculateRSI(data, params.rsi);
        let macd = calculateMACD(data);
        let candlePattern = detectCandlestickPattern(data[data.length - 1]);
    
        let closes = data.map(c => parseFloat(c[4]));
        let ema1_closed = calculateEMA(closes, params.ema1);
        let ema2_closed = calculateEMA(closes, params.ema2);
        let ema3_closed = calculateEMA(closes, params.ema3);
        let ema4_closed = calculateEMA(closes, params.ema4);
        document.getElementById("ema8").textContent = ema1_closed.toFixed(7);
        document.getElementById("ema21").textContent = ema2_closed.toFixed(7);
        document.getElementById("ema50").textContent = ema3_closed.toFixed(7);
        document.getElementById("ema200").textContent = ema4_closed.toFixed(7);
    
        lastClosedEma1 = ema1_closed;
        lastClosedEma2 = ema2_closed;
        lastClosedEma3 = ema3_closed;
        lastClosedEma4 = ema4_closed;
        prevLiveEma1 = ema1_closed;
        prevLiveEma2 = ema2_closed;
    
        let features = {
          pivot, r1, r2, r3, s1, s2, s3, atr, rsi, macd,
          candles: data,
          candlePattern,
          volumeSpike: parseFloat(data[data.length - 1][5]) > 100
        };
    
        let analysis = {};
        if (rsi > 65) {
          analysis["resistance3"] = "Strong Resistance";
          analysis["resistance2"] = "Strong Resistance";
          analysis["resistance1"] = "Strong Resistance";
          analysis["midR3R2"] = "Moderate Resistance";
        } else if (rsi > 50) {
          analysis["resistance3"] = "Moderate Resistance";
          analysis["resistance2"] = "Moderate Resistance";
          analysis["resistance1"] = "Moderate Resistance";
          analysis["midR3R2"] = "Moderate Resistance";
        } else {
          analysis["resistance3"] = "Weak Resistance";
          analysis["resistance2"] = "Weak Resistance";
          analysis["resistance1"] = "Weak Resistance";
          analysis["midR3R2"] = "Moderate Resistance";
        }
        analysis["midR2R1"] = "Moderate Resistance";
        analysis["midR1PP"] = "Adjacency";
        analysis["pivotPoint"] = "Central Pivot";
        if (rsi < 35) {
          analysis["midPPS1"] = "Moderate Support";
          analysis["support1"] = "Strong Support";
          analysis["support2"] = "Strong Support";
          analysis["support3"] = "Strong Support";
          analysis["midS1S2"] = "Strong Support";
          analysis["midS2S3"] = "Strong Support";
        } else if (rsi < 45) {
          analysis["midPPS1"] = "Moderate Support";
          analysis["support1"] = "Moderate Support";
          analysis["support2"] = "Moderate Support";
          analysis["support3"] = "Moderate Support";
          analysis["midS1S2"] = "Moderate Support";
          analysis["midS2S3"] = "Moderate Support";
        } else {
          analysis["midPPS1"] = "Moderate Support";
          analysis["support1"] = "Weak Support";
          analysis["support2"] = "Weak Support";
          analysis["support3"] = "Weak Support";
          analysis["midS1S2"] = "Weak Support";
          analysis["midS2S3"] = "Weak Support";
        }
        analysis["bollinger"] = (() => {
          let b = calculateBollingerBands(data);
          return `M: ${b.middle.toFixed(2)}, U: ${b.upper.toFixed(2)}, L: ${b.lower.toFixed(2)}`;
        })();
        analysis["sma50"] = calculateSMA(closes, 50).toFixed(2);
        analysis["sma200"] = calculateSMA(closes, 200).toFixed(2);
        analysis["candlePattern"] = candlePattern;
        let mlScore = predictMarketCrash(features);
        analysis["mlPrediction"] = mlScore > 50 ? "High crash probability" : "Low crash probability";
        let sentimentResult = getSentimentScore();
        analysis["sentiment"] = `${sentimentResult.sentiment} (${sentimentResult.score})`;
        let riskMgmt = riskManagementRecommendation(features);
        analysis["riskMgmt"] = `Stop: ${riskMgmt.stopLoss}, Target: ${riskMgmt.targetProfit}`;
        analysis["adx"] = calculateADX(data);
        let ichi = calculateIchimoku(data);
        analysis["ichimoku"] = `T:${ichi.tenkan}, K:${ichi.kijun}, A:${ichi.senkouA}, B:${ichi.senkouB}`;
        analysis["parabolic"] = calculateParabolicSAR(data);
        analysis["vwap"] = calculateVWAP(data);
        let orderFlow = (function() {
          let buy = Math.random() * 100;
          return { buy: buy.toFixed(2), sell: (100 - buy).toFixed(2) };
        })();
        analysis["orderFlow"] = `Buy: ${orderFlow.buy}%, Sell: ${orderFlow.sell}%`;
        analysis["advMlPrediction"] = advancedMLPrediction(features);
    
        document.getElementById("ai-resistance3").textContent = analysis["resistance3"];
        document.getElementById("ai-midR3R2").textContent   = analysis["midR3R2"];
        document.getElementById("ai-resistance2").textContent = analysis["resistance2"];
        document.getElementById("ai-midR2R1").textContent   = analysis["midR2R1"];
        document.getElementById("ai-resistance1").textContent = analysis["resistance1"];
        document.getElementById("ai-midR1PP").textContent    = analysis["midR1PP"];
        document.getElementById("ai-pivotPoint").textContent  = analysis["pivotPoint"];
        document.getElementById("ai-midPPS1").textContent     = analysis["midPPS1"];
        document.getElementById("ai-support1").textContent    = analysis["support1"];
        document.getElementById("ai-midS1S2").textContent     = analysis["midS1S2"];
        document.getElementById("ai-support2").textContent    = analysis["support2"];
        document.getElementById("ai-midS2S3").textContent     = analysis["midS2S3"];
        document.getElementById("ai-support3").textContent    = analysis["support3"];
        document.getElementById("ai-bollinger").textContent   = analysis["bollinger"];
        document.getElementById("ai-sma50").textContent       = analysis["sma50"];
        document.getElementById("ai-sma200").textContent      = analysis["sma200"];
        document.getElementById("ai-candlePattern").textContent = analysis["candlePattern"];
        document.getElementById("ai-mlPrediction").textContent  = analysis["mlPrediction"];
        document.getElementById("ai-sentiment").textContent     = analysis["sentiment"];
        document.getElementById("ai-riskMgmt").textContent      = analysis["riskMgmt"];
        document.getElementById("ai-adx").textContent           = analysis["adx"];
        document.getElementById("ai-ichimoku").textContent      = analysis["ichimoku"];
        document.getElementById("ai-parabolic").textContent     = analysis["parabolic"];
        document.getElementById("ai-vwap").textContent          = analysis["vwap"];
        document.getElementById("ai-orderFlow").textContent     = analysis["orderFlow"];
        document.getElementById("ai-advMlPrediction").textContent = analysis["advMlPrediction"];
    
        updateMarketTrendPanel(features);
        updateMultiTimeframeAnalysis(symbol);
        updatePivotPanelLivePricePosition();
      } catch (err) {
        console.error("Error updating pivot values:", err);
      }
      updateAdditionalAnalysis(symbol);
    }
    
    /*************** LIVE PRICE ROW PLACEMENT ***************/
    function updatePivotPanelLivePricePosition() {
      let livePrice = latestLivePrice;
      let levelOrder = [
        { id: "resistance3", value: parseFloat(document.getElementById("resistance3").textContent) || 0 },
        { id: "midR3R2", value: parseFloat(document.getElementById("midR3R2").textContent) || 0 },
        { id: "resistance2", value: parseFloat(document.getElementById("resistance2").textContent) || 0 },
        { id: "midR2R1", value: parseFloat(document.getElementById("midR2R1").textContent) || 0 },
        { id: "resistance1", value: parseFloat(document.getElementById("resistance1").textContent) || 0 },
        { id: "midR1PP", value: parseFloat(document.getElementById("midR1PP").textContent) || 0 },
        { id: "pivotPoint", value: parseFloat(document.getElementById("pivotPoint").textContent) || 0 },
        { id: "midPPS1", value: parseFloat(document.getElementById("midPPS1").textContent) || 0 },
        { id: "support1", value: parseFloat(document.getElementById("support1").textContent) || 0 },
        { id: "midS1S2", value: parseFloat(document.getElementById("midS1S2").textContent) || 0 },
        { id: "support2", value: parseFloat(document.getElementById("support2").textContent) || 0 },
        { id: "midS2S3", value: parseFloat(document.getElementById("midS2S3").textContent) || 0 },
        { id: "support3", value: parseFloat(document.getElementById("support3").textContent) || 0 }
      ];
      let tbody = document.querySelector("#pivotPanel tbody");
      let oldLiveRow = document.getElementById("livePriceRow");
      if (oldLiveRow) oldLiveRow.remove();
      let liveRow = document.createElement("tr");
      liveRow.id = "livePriceRow";
      let tdLabel = document.createElement("td");
      tdLabel.textContent = "Live Price";
      let tdValue = document.createElement("td");
      tdValue.textContent = livePrice.toFixed(7);
      let tdAi = document.createElement("td");
      tdAi.textContent = "-";
      liveRow.appendChild(tdLabel);
      liveRow.appendChild(tdValue);
      liveRow.appendChild(tdAi);
      let liveBG = loadColorSetting("livePrice", "bg", "rgba(76, 201, 240, 0.2)");
      let liveFont = loadColorSetting("livePrice", "font", "var(--dark-color)");
      liveRow.style.backgroundColor = liveBG;
      liveRow.style.color = liveFont;
      let inserted = false;
      for (let i = 0; i < levelOrder.length; i++) {
        if (livePrice >= levelOrder[i].value) {
          let rowElement = document.getElementById("row-" + levelOrder[i].id);
          if(rowElement) {
            tbody.insertBefore(liveRow, rowElement);
            inserted = true;
            break;
          }
        }
      }
      if (!inserted) {
        tbody.appendChild(liveRow);
      }
    }
    
    /*************** LIVE EMA UPDATES ***************/
    function updateLiveEMAAnalysis() {
      if (!lastClosedEma1 || !lastClosedEma2) return;
      let k1 = 2 / (params.ema1 + 1);
      let k2 = 2 / (params.ema2 + 1);
      let liveEma1 = (latestLivePrice - lastClosedEma1) * k1 + lastClosedEma1;
      let liveEma2 = (latestLivePrice - lastClosedEma2) * k2 + lastClosedEma2;
      document.getElementById("ema8").textContent = liveEma1.toFixed(2);
      document.getElementById("ema21").textContent = liveEma2.toFixed(2);
      document.getElementById("emaCrossValue").textContent = liveEma1.toFixed(7);
      let emaCrossoverSignal = "";
      if (prevLiveEma1 !== null && prevLiveEma2 !== null) {
        if (prevLiveEma1 <= prevLiveEma2 && liveEma1 > liveEma2) {
          emaCrossoverSignal = "Bullish";
        } else if (prevLiveEma1 >= prevLiveEma2 && liveEma1 < liveEma2) {
          emaCrossoverSignal = "Bearish";
        }
      }
      document.getElementById("ai-emaCross").textContent = emaCrossoverSignal;
      prevLiveEma1 = liveEma1;
      prevLiveEma2 = liveEma2;
    }
    
    setInterval(updateLiveEMAAnalysis, 1000);
    
    /*************** RANKING TABLE FUNCTIONS ***************/
    function updateRankingTable() {
      if(!allCoins.length) return;
      fetch("https://fapi.binance.com/fapi/v1/ticker/24hr")
        .then(res => res.json())
        .then(data => {
          fetchedRankingData = data.filter(item => allCoins.includes(item.symbol));
          globalRankMapping = {};
          let sorted = [...fetchedRankingData].sort((a, b) => parseFloat(b.quoteVolume) - parseFloat(a.quoteVolume));
          sorted.forEach((item, idx) => {
            globalRankMapping[item.symbol] = idx + 1;
          });
          renderRankingTable();
          updateTime();
        })
        .catch(err => console.error("Ranking update error:", err));
    }
    function renderRankingTable() {
      let data = [...fetchedRankingData];
      const searchQuery = document.getElementById("rankingSearch").value.toUpperCase();
      if (searchQuery) {
        data = data.filter(item => item.symbol.replace("USDT", "").toUpperCase().includes(searchQuery));
      }
      if (currentSortField === 'rank') {
        data.sort((a, b) => currentSortDir === 'asc' ? parseFloat(a.quoteVolume) - parseFloat(b.quoteVolume) : parseFloat(b.quoteVolume) - parseFloat(a.quoteVolume));
      } else if (currentSortField === 'coin') {
        data.sort((a, b) => {
          let A = a.symbol.replace("USDT", "").toUpperCase();
          let B = b.symbol.replace("USDT", "").toUpperCase();
          return currentSortDir === 'asc' ? (A < B ? -1 : 1) : (A < B ? 1 : -1);
        });
      } else if (currentSortField === 'live') {
        data.sort((a, b) => currentSortDir === 'asc' ? parseFloat(a.lastPrice) - parseFloat(b.lastPrice) : parseFloat(b.lastPrice) - parseFloat(a.lastPrice));
      }
      const tbody = document.getElementById("rankingTableBody");
      tbody.innerHTML = "";
      data.forEach(item => {
        let tr = document.createElement("tr");
        let tdRank = document.createElement("td");
        tdRank.textContent = globalRankMapping[item.symbol] || "N/A";
        tr.appendChild(tdRank);
        let tdCoin = document.createElement("td");
        let link = document.createElement("a");
        link.textContent = item.symbol.replace("USDT", "");
        link.className = "coin-link";
        link.onclick = () => { selectCoin(item.symbol); };
        tdCoin.appendChild(link);
        tr.appendChild(tdCoin);
        let tdLive = document.createElement("td");
        tdLive.textContent = parseFloat(item.lastPrice).toFixed(7);
        tr.appendChild(tdLive);
        tbody.appendChild(tr);
      });
    }
    function sortRanking(field) {
      if (currentSortField === field) {
        currentSortDir = currentSortDir === 'asc' ? 'desc' : 'asc';
      } else {
        currentSortField = field;
        currentSortDir = (field === 'rank') ? 'desc' : 'asc';
      }
      renderRankingTable();
    }
    function filterRanking() {
      renderRankingTable();
    }
    
    /*************** COIN SELECTION & SEARCH FUNCTIONS ***************/
    function selectCoin(symbol) {
      document.getElementById("coinSelector").value = symbol;
      updatePivotAndTradingSignals(symbol);
      // Uncomment next line if using WebSocket for live updates:
      // setupTickerWebSocket(symbol);
    }
    function searchCoin() {
      const searchTerm = document.getElementById("coinSearch").value.toUpperCase();
      if (!searchTerm) return;
      const coinSelector = document.getElementById("coinSelector");
      const options = coinSelector.options;
      for (let i = 0; i < options.length; i++) {
        if (options[i].text.toUpperCase().includes(searchTerm) || options[i].value.toUpperCase().includes(searchTerm)) {
          coinSelector.value = options[i].value;
          updatePivotAndTradingSignals(options[i].value);
          // setupTickerWebSocket(options[i].value);
          return;
        }
      }
      alert("Coin not found. Please try another search term.");
    }
    
    /*************** SETTINGS MODAL CONTROL FUNCTIONS ***************/
    function openSettings() {
      document.getElementById("settingsModal").style.display = "block";
    }
    function closeSettings() {
      document.getElementById("settingsModal").style.display = "none";
    }
    
    document.getElementById("timeFrame").addEventListener("change", function() {
      const coin = document.getElementById("coinSelector").value;
      if(coin) {
        updatePivotAndTradingSignals(coin);
        updateMultiTimeframeAnalysis(coin);
      }
    });
    
    /*************** MARKET TREND ANALYSIS (INCLUDING LIQUIDITY METRICS) ***************/
    function calculateMarketTrendAdvanced(features) {
      let score = 0;
      if(features.rsi > 60) { score += 20; }
      else if(features.rsi < 40) { score -= 20; }
      if(features.macd > 0) { score += 15; } else { score -= 15; }
      if(lastClosedEma1 && lastClosedEma2) {
        if(lastClosedEma1 > lastClosedEma2) { score += 10; }
        else { score -= 10; }
      }
      let closes = features.candles.map(c => parseFloat(c[4]));
      let sma50_val = calculateSMA(closes, 50);
      let sma200_val = calculateSMA(closes, 200);
      if(sma50_val > sma200_val) { score += 10; }
      else { score -= 10; }
      if(features.volumeSpike) { score += 5; }
      return { score };
    }
    
    function updateMarketTrendPanel(features) {
      let baseTrend = calculateMarketTrendAdvanced(features);
      let orderBookDepth = parseFloat(document.getElementById("orderBookDepth").textContent) || 0;
      let orderFlowVal = parseFloat(document.getElementById("orderFlowNew").textContent) || 50;
      let cvp = parseFloat(document.getElementById("volumeProfile").textContent) || features.pivot;
      let liquidityScore = (orderBookDepth * 10);
      liquidityScore += ((orderFlowVal - 50) / 5);
      liquidityScore += (cvp < features.pivot ? 5 : -5);
      let totalScore = baseTrend.score + liquidityScore;
      let bullish, bearish, stable, ignore;
      if(totalScore >= 20) {
         bullish = 70; bearish = 10; stable = 15; ignore = 5;
      } else if(totalScore >= 5) {
         bullish = 55; bearish = 15; stable = 25; ignore = 5;
      } else if(totalScore > -5) {
         bullish = 25; bearish = 25; stable = 45; ignore = 5;
      } else if(totalScore > -20) {
         bullish = 15; bearish = 55; stable = 25; ignore = 5;
      } else {
         bullish = 10; bearish = 70; stable = 15; ignore = 5;
      }
      let trend = "";
      if(totalScore >= 20) trend = "Bullish";
      else if(totalScore <= -20) trend = "Bearish";
      else {
         trend = "Stable";
         if(totalScore > 0) trend += " (Leaning Bullish)";
         else if(totalScore < 0) trend += " (Leaning Bearish)";
      }
      if(totalScore <= -30) trend += " - Market Danger";
      
      let trendTable = `
         <table style="width:100%; border:1px solid rgba(0,0,0,0.05);">
           <tr>
             <th style="background: linear-gradient(135deg, var(--success-color), var(--accent-color));">Bullish</th>
             <th style="background: linear-gradient(135deg, var(--danger-color), var(--warning-color));">Bearish</th>
             <th style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));">Stable</th>
             <th style="background: linear-gradient(135deg, #6c757d, #495057);">Ignore</th>
           </tr>
           <tr>
             <td style="background: rgba(40, 167, 69, 0.1);">${bullish}%</td>
             <td style="background: rgba(220, 53, 69, 0.1);">${bearish}%</td>
             <td style="background: rgba(67, 97, 238, 0.1);">${stable}%</td>
             <td style="background: rgba(108, 117, 125, 0.1);">${ignore}%</td>
           </tr>
         </table>
         <p style="font-size: 1.1rem; margin-top: 15px; font-weight: 600; color: ${totalScore >= 20 ? 'var(--success-color)' : totalScore <= -20 ? 'var(--danger-color)' : 'var(--primary-color)'}">Market Trend: ${trend} (Score: ${totalScore.toFixed(2)})</p>
      `;
      let recommendation = "";
      if(trend.toLowerCase().includes("bearish")) {
          recommendation = `<div style="background: rgba(220, 53, 69, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid var(--danger-color);">
            <strong style="color: var(--danger-color);">Bearish trend detected.</strong> Recommendation: <strong>SELL</strong>. Suggested sell price: <strong>${(features.pivot * 1.02).toFixed(2)}</strong>. Allocate around 60% towards SELL.
          </div>`;
      } else if(trend.toLowerCase().includes("bullish")) {
          recommendation = `<div style="background: rgba(40, 167, 69, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid var(--success-color);">
            <strong style="color: var(--success-color);">Bullish trend detected.</strong> Recommendation: <strong>BUY</strong>. Suggested buy price: <strong>${(features.pivot * 0.98).toFixed(2)}</strong>. Allocate around 60% towards BUY.
          </div>`;
      } else {
          recommendation = `<div style="background: rgba(67, 97, 238, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary-color);">
            <strong style="color: var(--primary-color);">Market is stable</strong> with no clear recommendation.
          </div>`;
      }
      document.getElementById("trendAnalysisContent").innerHTML = trendTable + recommendation;
    }
    
    /*************** MULTI-TIMEFRAME ANALYSIS ***************/
    async function updateMultiTimeframeAnalysis(symbol) {
      if(!symbol) return;
      const timeFrames = ["15m", "30m", "1h", "4h", "1d", "1w", "1M"];
      let analyses = [];
      for (let tf of timeFrames) {
        try {
          let data = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=${tf}&limit=50`)
            .then(res => res.json());
          if (!Array.isArray(data) || data.length < 2) continue;
          let pivotCandle = data[data.length - 2];
          let high = parseFloat(pivotCandle[2]), low = parseFloat(pivotCandle[3]), close = parseFloat(pivotCandle[4]);
          let pivot = (high + low + close) / 3;
          let rsi = calculateRSI(data, params.rsi);
          let closes = data.map(c => parseFloat(c[4]));
          let emaShort = calculateEMA(closes, params.ema1);
          let emaLong = calculateEMA(closes, params.ema2);
          let crossoverSignal = "Neutral";
          if (emaShort > emaLong) crossoverSignal = "Bullish";
          else if (emaShort < emaLong) crossoverSignal = "Bearish";
          let analysisString = `<strong>${tf}</strong><br>Pivot: ${pivot.toFixed(2)}<br>RSI: ${rsi.toFixed(2)}<br>EMA Crossover: ${crossoverSignal}`;
          analyses.push(analysisString);
        } catch (err) {
          console.error("Error in multi-timeframe analysis for " + tf, err);
        }
      }
      let half = Math.ceil(analyses.length / 2);
      let leftColumn = analyses.slice(0, half);
      let rightColumn = analyses.slice(half);
      let tableHtml = `<table style="width:100%;"><tr><td style="vertical-align:top;">`;
      tableHtml += leftColumn.join("<br><br>");
      tableHtml += `</td><td style="vertical-align:top;">`;
      tableHtml += rightColumn.join("<br><br>");
      tableHtml += `</td></tr></table>`;
      document.getElementById("multiTfContent").innerHTML = tableHtml;
    }
    
    /*************** INITIALIZATION ON LOAD ***************/
    async function init() {
      loadParams();
      loadColorSettings();
      try {
        let response = await fetch("https://fapi.binance.com/fapi/v1/exchangeInfo");
        let exchangeInfo = await response.json();
        if (!exchangeInfo.symbols) {
          console.log("No symbols found in exchangeInfo.");
          return;
        }
        const coinSelector = document.getElementById("coinSelector");
        allCoins = exchangeInfo.symbols.filter(sym => sym.symbol.endsWith("USDT")).map(sym => sym.symbol);
        allCoins.forEach(symbol => {
          let option = document.createElement("option");
          option.value = symbol;
          option.textContent = symbol.replace("USDT", "");
          coinSelector.appendChild(option);
        });
        if (allCoins.includes("BTCUSDT")) {
          coinSelector.value = "BTCUSDT";
          await updatePivotAndTradingSignals("BTCUSDT");
          // Uncomment if WebSocket live update is desired:
          // setupTickerWebSocket("BTCUSDT");
        }
        updateRankingTable();
      } catch (err) {
        console.error("Initialization error:", err);
      }
    }
    
    /*************** UPDATE TIME ***************/
    function updateTime() {
      document.getElementById("updateTime").textContent = "Last Updated: " + new Date().toLocaleTimeString();
    }
    
    // Update pivot & additional analysis every second if coin is selected
    setInterval(() => {
      let symbol = document.getElementById("coinSelector").value;
      if(symbol) updatePivotAndTradingSignals(symbol);
    }, 1000);
    
    // Update Ranking Table every 5 seconds for live value stability
    setInterval(() => {
      updateRankingTable();
    }, 5000);
    
    // Initialize dashboard on load
    init();
  </script>
</body>
</html>